{
  "nodes": [
    {
      "content": "流分析中常用使用模式的查询示例 | Azure",
      "pos": [
        27,
        50
      ]
    },
    {
      "content": "常见的 Azure 流分析查询模式",
      "pos": [
        69,
        86
      ]
    },
    {
      "content": "常用流分析使用模式的查询示例",
      "pos": [
        340,
        354
      ]
    },
    {
      "content": "介绍",
      "pos": [
        361,
        363
      ]
    },
    {
      "pos": [
        368,
        532
      ],
      "content": "Azure 流分析中的查询采用类似 SQL 的查询语言来表述，该语言的文档说明见<bpt id=\"p1\">[</bpt>此处<ept id=\"p1\">](https://msdn.microsoft.com/zh-cn/library/azure/dn834998.aspx)</ept>。本文档概述了针对多个常见查询模式的解决方案，依据的是真实的场景。此工作仍在进行中，将继续使用新的模式不断进行更新。"
    },
    {
      "content": "查询示例：数据类型转换",
      "pos": [
        537,
        548
      ]
    },
    {
      "pos": [
        552,
        611
      ],
      "content": "<bpt id=\"p1\">**</bpt>说明<ept id=\"p1\">**</ept>：定义输入流中的属性类型，例如，车重在输入流中是字符串格式的，需要转换为 INT 才能执行 SUM 操作。"
    },
    {
      "pos": [
        613,
        620
      ],
      "content": "<bpt id=\"p1\">**</bpt>输入<ept id=\"p1\">**</ept>："
    },
    {
      "content": "请确",
      "pos": [
        624,
        626
      ]
    },
    {
      "content": "时间",
      "pos": [
        629,
        631
      ]
    },
    {
      "content": "重量",
      "pos": [
        634,
        636
      ]
    },
    {
      "content": "Honda",
      "pos": [
        661,
        666
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        669,
        697
      ]
    },
    {
      "content": "\"1000\"",
      "pos": [
        700,
        706
      ]
    },
    {
      "content": "Honda",
      "pos": [
        711,
        716
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        719,
        747
      ]
    },
    {
      "content": "\"2000\"",
      "pos": [
        750,
        756
      ]
    },
    {
      "pos": [
        760,
        767
      ],
      "content": "<bpt id=\"p1\">**</bpt>输出<ept id=\"p1\">**</ept>："
    },
    {
      "content": "请确",
      "pos": [
        771,
        773
      ]
    },
    {
      "content": "重量",
      "pos": [
        776,
        778
      ]
    },
    {
      "content": "Honda",
      "pos": [
        797,
        802
      ]
    },
    {
      "content": "3000",
      "pos": [
        805,
        809
      ]
    },
    {
      "pos": [
        813,
        822
      ],
      "content": "<bpt id=\"p1\">**</bpt>解决方案<ept id=\"p1\">**</ept>："
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>说明<ept id=\"p1\">**</ept>：",
      "pos": [
        999,
        1006
      ]
    },
    {
      "content": "对“重量”字段使用 CAST 语句，以便指定其类型（请在<bpt id=\"p1\">[</bpt>此处<ept id=\"p1\">](https://msdn.microsoft.com/zh-cn/library/azure/dn835065.aspx)</ept>查看受支持数据类型的列表）。",
      "pos": [
        1007,
        1115
      ]
    },
    {
      "content": "查询示例：使用 Like/Not like 进行模式匹配",
      "pos": [
        1120,
        1148
      ]
    },
    {
      "pos": [
        1152,
        1200
      ],
      "content": "<bpt id=\"p1\">**</bpt>说明<ept id=\"p1\">**</ept>：查看事件中的某个字段值是否符合特定模式，例如，返回以 A 开头，以 9 结尾的牌照"
    },
    {
      "pos": [
        1202,
        1209
      ],
      "content": "<bpt id=\"p1\">**</bpt>输入<ept id=\"p1\">**</ept>："
    },
    {
      "content": "请确",
      "pos": [
        1213,
        1215
      ]
    },
    {
      "content": "LicensePlate",
      "pos": [
        1218,
        1230
      ]
    },
    {
      "content": "时间",
      "pos": [
        1233,
        1235
      ]
    },
    {
      "content": "Honda",
      "pos": [
        1260,
        1265
      ]
    },
    {
      "content": "ABC-123",
      "pos": [
        1268,
        1275
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        1278,
        1306
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        1311,
        1317
      ]
    },
    {
      "content": "AAA-999",
      "pos": [
        1320,
        1327
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        1330,
        1358
      ]
    },
    {
      "content": "Nissan",
      "pos": [
        1363,
        1369
      ]
    },
    {
      "content": "ABC-369",
      "pos": [
        1372,
        1379
      ]
    },
    {
      "content": "2015-01-01T00:00:03.0000000Z",
      "pos": [
        1382,
        1410
      ]
    },
    {
      "pos": [
        1414,
        1421
      ],
      "content": "<bpt id=\"p1\">**</bpt>输出<ept id=\"p1\">**</ept>："
    },
    {
      "content": "请确",
      "pos": [
        1425,
        1427
      ]
    },
    {
      "content": "LicensePlate",
      "pos": [
        1430,
        1442
      ]
    },
    {
      "content": "时间",
      "pos": [
        1445,
        1447
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        1472,
        1478
      ]
    },
    {
      "content": "AAA-999",
      "pos": [
        1481,
        1488
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        1491,
        1519
      ]
    },
    {
      "content": "Nissan",
      "pos": [
        1524,
        1530
      ]
    },
    {
      "content": "ABC-369",
      "pos": [
        1533,
        1540
      ]
    },
    {
      "content": "2015-01-01T00:00:03.0000000Z",
      "pos": [
        1543,
        1571
      ]
    },
    {
      "pos": [
        1575,
        1584
      ],
      "content": "<bpt id=\"p1\">**</bpt>解决方案<ept id=\"p1\">**</ept>："
    },
    {
      "pos": [
        1691,
        1774
      ],
      "content": "<bpt id=\"p1\">**</bpt>说明<ept id=\"p1\">**</ept>：使用 LIKE 语句来查看 LicensePlate 字段值是否以 A 开头、后面所跟的字符串是否包含 0 个或 0 个以上字符，以及是否以 9 结尾。"
    },
    {
      "content": "查询示例：指定不同案例/值的逻辑（CASE 语句）",
      "pos": [
        1779,
        1804
      ]
    },
    {
      "pos": [
        1808,
        1875
      ],
      "content": "<bpt id=\"p1\">**</bpt>说明<ept id=\"p1\">**</ept>：根据某些标准为字段提供不同的计算操作。例如，提供一个字符串说明，说明有多少辆制造商相同的车通过，特殊情况下该数目为 1。"
    },
    {
      "pos": [
        1877,
        1884
      ],
      "content": "<bpt id=\"p1\">**</bpt>输入<ept id=\"p1\">**</ept>："
    },
    {
      "content": "请确",
      "pos": [
        1888,
        1890
      ]
    },
    {
      "content": "时间",
      "pos": [
        1893,
        1895
      ]
    },
    {
      "content": "Honda",
      "pos": [
        1914,
        1919
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        1922,
        1950
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        1955,
        1961
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        1964,
        1992
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        1997,
        2003
      ]
    },
    {
      "content": "2015-01-01T00:00:03.0000000Z",
      "pos": [
        2006,
        2034
      ]
    },
    {
      "pos": [
        2038,
        2045
      ],
      "content": "<bpt id=\"p1\">**</bpt>输出<ept id=\"p1\">**</ept>："
    },
    {
      "content": "| CarsPassed | 时间 |",
      "pos": [
        2047,
        2066
      ]
    },
    {
      "content": "| --- | --- | --- |",
      "pos": [
        2067,
        2086
      ]
    },
    {
      "content": "| 1 辆 Honda | 2015-01-01T00:00:10.0000000Z |",
      "pos": [
        2087,
        2131
      ]
    },
    {
      "content": "| 2 辆 Toyota | 2015-01-01T00:00:10.0000000Z |",
      "pos": [
        2132,
        2177
      ]
    },
    {
      "pos": [
        2179,
        2188
      ],
      "content": "<bpt id=\"p1\">**</bpt>解决方案<ept id=\"p1\">**</ept>："
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>说明<ept id=\"p1\">**</ept>：",
      "pos": [
        2505,
        2512
      ]
    },
    {
      "content": "可以通过 CASE 子句根据某些标准（在我们这个示例中为聚合窗口中车辆的计数）来提供不同的计算操作。",
      "pos": [
        2513,
        2563
      ]
    },
    {
      "content": "查询示例：将数据发送到多个输出",
      "pos": [
        2568,
        2583
      ]
    },
    {
      "pos": [
        2587,
        2649
      ],
      "content": "<bpt id=\"p1\">**</bpt>说明<ept id=\"p1\">**</ept>：将数据从单个作业发送到多个输出目标。例如，对数据进行分析，根据阈值发出警报，并将所有事件存档到 blob 存储"
    },
    {
      "pos": [
        2651,
        2658
      ],
      "content": "<bpt id=\"p1\">**</bpt>输入<ept id=\"p1\">**</ept>："
    },
    {
      "content": "请确",
      "pos": [
        2662,
        2664
      ]
    },
    {
      "content": "时间",
      "pos": [
        2667,
        2669
      ]
    },
    {
      "content": "Honda",
      "pos": [
        2688,
        2693
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        2696,
        2724
      ]
    },
    {
      "content": "Honda",
      "pos": [
        2729,
        2734
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        2737,
        2765
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        2770,
        2776
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        2779,
        2807
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        2812,
        2818
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        2821,
        2849
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        2854,
        2860
      ]
    },
    {
      "content": "2015-01-01T00:00:03.0000000Z",
      "pos": [
        2863,
        2891
      ]
    },
    {
      "pos": [
        2895,
        2904
      ],
      "content": "<bpt id=\"p1\">**</bpt>输出 1<ept id=\"p1\">**</ept>："
    },
    {
      "content": "请确",
      "pos": [
        2908,
        2910
      ]
    },
    {
      "content": "时间",
      "pos": [
        2913,
        2915
      ]
    },
    {
      "content": "Honda",
      "pos": [
        2934,
        2939
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        2942,
        2970
      ]
    },
    {
      "content": "Honda",
      "pos": [
        2975,
        2980
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        2983,
        3011
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        3016,
        3022
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        3025,
        3053
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        3058,
        3064
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        3067,
        3095
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        3100,
        3106
      ]
    },
    {
      "content": "2015-01-01T00:00:03.0000000Z",
      "pos": [
        3109,
        3137
      ]
    },
    {
      "pos": [
        3141,
        3150
      ],
      "content": "<bpt id=\"p1\">**</bpt>输出 2<ept id=\"p1\">**</ept>："
    },
    {
      "content": "请确",
      "pos": [
        3154,
        3156
      ]
    },
    {
      "content": "时间",
      "pos": [
        3159,
        3161
      ]
    },
    {
      "content": "计数",
      "pos": [
        3164,
        3166
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        3191,
        3197
      ]
    },
    {
      "content": "2015-01-01T00:00:10.0000000Z",
      "pos": [
        3200,
        3228
      ]
    },
    {
      "content": "3",
      "pos": [
        3231,
        3232
      ]
    },
    {
      "pos": [
        3236,
        3245
      ],
      "content": "<bpt id=\"p1\">**</bpt>解决方案<ept id=\"p1\">**</ept>："
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>说明<ept id=\"p1\">**</ept>：",
      "pos": [
        3593,
        3600
      ]
    },
    {
      "content": "INTO 子句告诉流分析哪一个输出可以通过此语句写入数据。第一个查询将我们接收到的数据传递到名为 ArchiveOutput 的输出。第二个查询进行了一些简单的聚合和筛选操作，然后将结果发送到下游的报警系统。<bpt id=\"p1\">*</bpt>注意<ept id=\"p1\">*</ept>：你可以重复使用多个输出语句中的 CTE（即 WITH 语句）结果 – 这有一些额外的好处，例如，在读取输入源时，可以打开较少的读取器。",
      "pos": [
        3601,
        3777
      ]
    },
    {
      "content": "查询示例：对唯一值进行计数",
      "pos": [
        4068,
        4081
      ]
    },
    {
      "pos": [
        4082,
        4141
      ],
      "content": "<bpt id=\"p1\">**</bpt>说明<ept id=\"p1\">**</ept>：计算某个时段内出现在流中的唯一字段值的数目。例如，在 2 秒内，有多少由某个制造商制造的车通过了收费亭？"
    },
    {
      "pos": [
        4143,
        4150
      ],
      "content": "<bpt id=\"p1\">**</bpt>输入<ept id=\"p1\">**</ept>："
    },
    {
      "content": "请确",
      "pos": [
        4154,
        4156
      ]
    },
    {
      "content": "时间",
      "pos": [
        4159,
        4161
      ]
    },
    {
      "content": "Honda",
      "pos": [
        4180,
        4185
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        4188,
        4216
      ]
    },
    {
      "content": "Honda",
      "pos": [
        4221,
        4226
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        4229,
        4257
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        4262,
        4268
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        4271,
        4299
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        4304,
        4310
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        4313,
        4341
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        4346,
        4352
      ]
    },
    {
      "content": "2015-01-01T00:00:03.0000000Z",
      "pos": [
        4355,
        4383
      ]
    },
    {
      "content": "输出：",
      "pos": [
        4389,
        4392
      ]
    },
    {
      "content": "计数",
      "pos": [
        4398,
        4400
      ]
    },
    {
      "content": "时间",
      "pos": [
        4403,
        4405
      ]
    },
    {
      "content": "2",
      "pos": [
        4424,
        4425
      ]
    },
    {
      "content": "2015-01-01T00:00:02.000Z",
      "pos": [
        4428,
        4452
      ]
    },
    {
      "content": "1",
      "pos": [
        4457,
        4458
      ]
    },
    {
      "content": "2015-01-01T00:00:04.000Z",
      "pos": [
        4461,
        4485
      ]
    },
    {
      "content": "解决方案：",
      "pos": [
        4491,
        4496
      ]
    },
    {
      "content": "说明：",
      "pos": [
        4864,
        4867
      ]
    },
    {
      "content": "我们会进行一个初始的聚合来获得该时段内通过的车辆所属的不同制造商以及车辆的计数。然后，我们会进行一个聚合来计算有多少个制造商 – 在提供了某个时段内所有唯一值的情况下，我们可以获得相同的时间戳，然后，第二个聚合窗口需要尽可能小，不能聚合第一步中的 2 个窗口。",
      "pos": [
        4870,
        5000
      ]
    },
    {
      "content": "查询示例：确定某个值是否已更改",
      "pos": [
        5005,
        5020
      ]
    },
    {
      "pos": [
        5024,
        5081
      ],
      "content": "<bpt id=\"p1\">**</bpt>说明<ept id=\"p1\">**</ept>：查看以前的值，确定其是否不同于当前值。例如，收费公路上前一辆车的制造商是否与目前这辆车的制造商相同？"
    },
    {
      "pos": [
        5083,
        5090
      ],
      "content": "<bpt id=\"p1\">**</bpt>输入<ept id=\"p1\">**</ept>："
    },
    {
      "content": "请确",
      "pos": [
        5094,
        5096
      ]
    },
    {
      "content": "时间",
      "pos": [
        5099,
        5101
      ]
    },
    {
      "content": "Honda",
      "pos": [
        5120,
        5125
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        5128,
        5156
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        5161,
        5167
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        5170,
        5198
      ]
    },
    {
      "pos": [
        5202,
        5209
      ],
      "content": "<bpt id=\"p1\">**</bpt>输出<ept id=\"p1\">**</ept>："
    },
    {
      "content": "请确",
      "pos": [
        5213,
        5215
      ]
    },
    {
      "content": "时间",
      "pos": [
        5218,
        5220
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        5239,
        5245
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        5248,
        5276
      ]
    },
    {
      "pos": [
        5280,
        5289
      ],
      "content": "<bpt id=\"p1\">**</bpt>解决方案<ept id=\"p1\">**</ept>："
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>说明<ept id=\"p1\">**</ept>：",
      "pos": [
        5443,
        5450
      ]
    },
    {
      "content": "使用 LAG 来查看后退一个事件之后的输入流，然后即可获得“制造商”字段的值。然后，将其与当前事件的“制造商”字段进行比较，如果二者不同，则输出该事件。",
      "pos": [
        5451,
        5527
      ]
    },
    {
      "content": "查询示例：在窗口中查找第一个事件",
      "pos": [
        5532,
        5548
      ]
    },
    {
      "pos": [
        5552,
        5580
      ],
      "content": "<bpt id=\"p1\">**</bpt>说明<ept id=\"p1\">**</ept>：查找每个 10 分钟时间间隔内的第一辆车？"
    },
    {
      "pos": [
        5582,
        5589
      ],
      "content": "<bpt id=\"p1\">**</bpt>输入<ept id=\"p1\">**</ept>："
    },
    {
      "content": "牌照",
      "pos": [
        5593,
        5595
      ]
    },
    {
      "content": "请确",
      "pos": [
        5598,
        5600
      ]
    },
    {
      "content": "时间",
      "pos": [
        5603,
        5605
      ]
    },
    {
      "content": "DXE 5291",
      "pos": [
        5630,
        5638
      ]
    },
    {
      "content": "Honda",
      "pos": [
        5641,
        5646
      ]
    },
    {
      "content": "2015-07-27T00:00:05.0000000Z",
      "pos": [
        5649,
        5677
      ]
    },
    {
      "content": "YZK 5704",
      "pos": [
        5682,
        5690
      ]
    },
    {
      "content": "Ford",
      "pos": [
        5693,
        5697
      ]
    },
    {
      "content": "2015-07-27T00:02:17.0000000Z",
      "pos": [
        5700,
        5728
      ]
    },
    {
      "content": "RMV 8282",
      "pos": [
        5733,
        5741
      ]
    },
    {
      "content": "Honda",
      "pos": [
        5744,
        5749
      ]
    },
    {
      "content": "2015-07-27T00:05:01.0000000Z",
      "pos": [
        5752,
        5780
      ]
    },
    {
      "content": "YHN 6970",
      "pos": [
        5785,
        5793
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        5796,
        5802
      ]
    },
    {
      "content": "2015-07-27T00:06:00.0000000Z",
      "pos": [
        5805,
        5833
      ]
    },
    {
      "content": "VFE 1616",
      "pos": [
        5838,
        5846
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        5849,
        5855
      ]
    },
    {
      "content": "2015-07-27T00:09:31.0000000Z",
      "pos": [
        5858,
        5886
      ]
    },
    {
      "content": "QYF 9358",
      "pos": [
        5891,
        5899
      ]
    },
    {
      "content": "Honda",
      "pos": [
        5902,
        5907
      ]
    },
    {
      "content": "2015-07-27T00:12:02.0000000Z",
      "pos": [
        5910,
        5938
      ]
    },
    {
      "content": "MDR 6128",
      "pos": [
        5943,
        5951
      ]
    },
    {
      "content": "BMW",
      "pos": [
        5954,
        5957
      ]
    },
    {
      "content": "2015-07-27T00:13:45.0000000Z",
      "pos": [
        5960,
        5988
      ]
    },
    {
      "pos": [
        5992,
        5999
      ],
      "content": "<bpt id=\"p1\">**</bpt>输出<ept id=\"p1\">**</ept>："
    },
    {
      "content": "牌照",
      "pos": [
        6003,
        6005
      ]
    },
    {
      "content": "请确",
      "pos": [
        6008,
        6010
      ]
    },
    {
      "content": "时间",
      "pos": [
        6013,
        6015
      ]
    },
    {
      "content": "DXE 5291",
      "pos": [
        6040,
        6048
      ]
    },
    {
      "content": "Honda",
      "pos": [
        6051,
        6056
      ]
    },
    {
      "content": "2015-07-27T00:00:05.0000000Z",
      "pos": [
        6059,
        6087
      ]
    },
    {
      "content": "QYF 9358",
      "pos": [
        6092,
        6100
      ]
    },
    {
      "content": "Honda",
      "pos": [
        6103,
        6108
      ]
    },
    {
      "content": "2015-07-27T00:12:02.0000000Z",
      "pos": [
        6111,
        6139
      ]
    },
    {
      "pos": [
        6143,
        6152
      ],
      "content": "<bpt id=\"p1\">**</bpt>解决方案<ept id=\"p1\">**</ept>："
    },
    {
      "content": "现在，我们来变一下这个问题，查找每 10 分钟时间间隔内特定制造商的第一辆车。",
      "pos": [
        6301,
        6340
      ]
    },
    {
      "content": "牌照",
      "pos": [
        6344,
        6346
      ]
    },
    {
      "content": "请确",
      "pos": [
        6349,
        6351
      ]
    },
    {
      "content": "时间",
      "pos": [
        6354,
        6356
      ]
    },
    {
      "content": "DXE 5291",
      "pos": [
        6381,
        6389
      ]
    },
    {
      "content": "Honda",
      "pos": [
        6392,
        6397
      ]
    },
    {
      "content": "2015-07-27T00:00:05.0000000Z",
      "pos": [
        6400,
        6428
      ]
    },
    {
      "content": "YZK 5704",
      "pos": [
        6433,
        6441
      ]
    },
    {
      "content": "Ford",
      "pos": [
        6444,
        6448
      ]
    },
    {
      "content": "2015-07-27T00:02:17.0000000Z",
      "pos": [
        6451,
        6479
      ]
    },
    {
      "content": "YHN 6970",
      "pos": [
        6484,
        6492
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        6495,
        6501
      ]
    },
    {
      "content": "2015-07-27T00:06:00.0000000Z",
      "pos": [
        6504,
        6532
      ]
    },
    {
      "content": "QYF 9358",
      "pos": [
        6537,
        6545
      ]
    },
    {
      "content": "Honda",
      "pos": [
        6548,
        6553
      ]
    },
    {
      "content": "2015-07-27T00:12:02.0000000Z",
      "pos": [
        6556,
        6584
      ]
    },
    {
      "content": "MDR 6128",
      "pos": [
        6589,
        6597
      ]
    },
    {
      "content": "BMW",
      "pos": [
        6600,
        6603
      ]
    },
    {
      "content": "2015-07-27T00:13:45.0000000Z",
      "pos": [
        6606,
        6634
      ]
    },
    {
      "pos": [
        6638,
        6647
      ],
      "content": "<bpt id=\"p1\">**</bpt>解决方案<ept id=\"p1\">**</ept>："
    },
    {
      "content": "查询示例：在窗口中查找最后一个事件",
      "pos": [
        6824,
        6841
      ]
    },
    {
      "pos": [
        6845,
        6873
      ],
      "content": "<bpt id=\"p1\">**</bpt>说明<ept id=\"p1\">**</ept>：在每 10 分钟时间间隔内查找最后一辆车。"
    },
    {
      "pos": [
        6875,
        6882
      ],
      "content": "<bpt id=\"p1\">**</bpt>输入<ept id=\"p1\">**</ept>："
    },
    {
      "content": "牌照",
      "pos": [
        6886,
        6888
      ]
    },
    {
      "content": "请确",
      "pos": [
        6891,
        6893
      ]
    },
    {
      "content": "时间",
      "pos": [
        6896,
        6898
      ]
    },
    {
      "content": "DXE 5291",
      "pos": [
        6923,
        6931
      ]
    },
    {
      "content": "Honda",
      "pos": [
        6934,
        6939
      ]
    },
    {
      "content": "2015-07-27T00:00:05.0000000Z",
      "pos": [
        6942,
        6970
      ]
    },
    {
      "content": "YZK 5704",
      "pos": [
        6975,
        6983
      ]
    },
    {
      "content": "Ford",
      "pos": [
        6986,
        6990
      ]
    },
    {
      "content": "2015-07-27T00:02:17.0000000Z",
      "pos": [
        6993,
        7021
      ]
    },
    {
      "content": "RMV 8282",
      "pos": [
        7026,
        7034
      ]
    },
    {
      "content": "Honda",
      "pos": [
        7037,
        7042
      ]
    },
    {
      "content": "2015-07-27T00:05:01.0000000Z",
      "pos": [
        7045,
        7073
      ]
    },
    {
      "content": "YHN 6970",
      "pos": [
        7078,
        7086
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        7089,
        7095
      ]
    },
    {
      "content": "2015-07-27T00:06:00.0000000Z",
      "pos": [
        7098,
        7126
      ]
    },
    {
      "content": "VFE 1616",
      "pos": [
        7131,
        7139
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        7142,
        7148
      ]
    },
    {
      "content": "2015-07-27T00:09:31.0000000Z",
      "pos": [
        7151,
        7179
      ]
    },
    {
      "content": "QYF 9358",
      "pos": [
        7184,
        7192
      ]
    },
    {
      "content": "Honda",
      "pos": [
        7195,
        7200
      ]
    },
    {
      "content": "2015-07-27T00:12:02.0000000Z",
      "pos": [
        7203,
        7231
      ]
    },
    {
      "content": "MDR 6128",
      "pos": [
        7236,
        7244
      ]
    },
    {
      "content": "BMW",
      "pos": [
        7247,
        7250
      ]
    },
    {
      "content": "2015-07-27T00:13:45.0000000Z",
      "pos": [
        7253,
        7281
      ]
    },
    {
      "pos": [
        7285,
        7292
      ],
      "content": "<bpt id=\"p1\">**</bpt>输出<ept id=\"p1\">**</ept>："
    },
    {
      "content": "牌照",
      "pos": [
        7296,
        7298
      ]
    },
    {
      "content": "请确",
      "pos": [
        7301,
        7303
      ]
    },
    {
      "content": "时间",
      "pos": [
        7306,
        7308
      ]
    },
    {
      "content": "VFE 1616",
      "pos": [
        7333,
        7341
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        7344,
        7350
      ]
    },
    {
      "content": "2015-07-27T00:09:31.0000000Z",
      "pos": [
        7353,
        7381
      ]
    },
    {
      "content": "MDR 6128",
      "pos": [
        7386,
        7394
      ]
    },
    {
      "content": "BMW",
      "pos": [
        7397,
        7400
      ]
    },
    {
      "content": "2015-07-27T00:13:45.0000000Z",
      "pos": [
        7403,
        7431
      ]
    },
    {
      "pos": [
        7435,
        7444
      ],
      "content": "<bpt id=\"p1\">**</bpt>解决方案<ept id=\"p1\">**</ept>："
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>说明<ept id=\"p1\">**</ept>：",
      "pos": [
        7917,
        7924
      ]
    },
    {
      "content": "此查询中有两个步骤 – 第一个步骤是查找 10 分钟时间窗口内最后一个时间戳。第二个步骤需要将第一个查询的结果与初始流联接起来，查找每个窗口中与最后一个时间戳匹配的事件。",
      "pos": [
        7925,
        8010
      ]
    },
    {
      "content": "查询示例：检测缺少的事件",
      "pos": [
        8015,
        8027
      ]
    },
    {
      "pos": [
        8031,
        8092
      ],
      "content": "<bpt id=\"p1\">**</bpt>说明<ept id=\"p1\">**</ept>：查看某个流是否没有值符合特定的标准。例如，在 90 秒内，是否有 2 辆一起进入收费公路的车来自同一制造商？"
    },
    {
      "pos": [
        8094,
        8101
      ],
      "content": "<bpt id=\"p1\">**</bpt>输入<ept id=\"p1\">**</ept>："
    },
    {
      "content": "请确",
      "pos": [
        8105,
        8107
      ]
    },
    {
      "content": "牌照",
      "pos": [
        8110,
        8112
      ]
    },
    {
      "content": "时间",
      "pos": [
        8115,
        8117
      ]
    },
    {
      "content": "Honda",
      "pos": [
        8142,
        8147
      ]
    },
    {
      "content": "ABC-123",
      "pos": [
        8150,
        8157
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        8160,
        8188
      ]
    },
    {
      "content": "Honda",
      "pos": [
        8193,
        8198
      ]
    },
    {
      "content": "AAA-999",
      "pos": [
        8201,
        8208
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        8211,
        8239
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        8244,
        8250
      ]
    },
    {
      "content": "DEF-987",
      "pos": [
        8253,
        8260
      ]
    },
    {
      "content": "2015-01-01T00:00:03.0000000Z",
      "pos": [
        8263,
        8291
      ]
    },
    {
      "content": "Honda",
      "pos": [
        8296,
        8301
      ]
    },
    {
      "content": "GHI-345",
      "pos": [
        8304,
        8311
      ]
    },
    {
      "content": "2015-01-01T00:00:04.0000000Z",
      "pos": [
        8314,
        8342
      ]
    },
    {
      "pos": [
        8346,
        8353
      ],
      "content": "<bpt id=\"p1\">**</bpt>输出<ept id=\"p1\">**</ept>："
    },
    {
      "content": "请确",
      "pos": [
        8357,
        8359
      ]
    },
    {
      "content": "时间",
      "pos": [
        8362,
        8364
      ]
    },
    {
      "content": "CurrentCarLicensePlate",
      "pos": [
        8367,
        8389
      ]
    },
    {
      "content": "FirstCarLicensePlate",
      "pos": [
        8392,
        8412
      ]
    },
    {
      "content": "FirstCarTime",
      "pos": [
        8415,
        8427
      ]
    },
    {
      "content": "Honda",
      "pos": [
        8464,
        8469
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        8472,
        8500
      ]
    },
    {
      "content": "AAA-999",
      "pos": [
        8503,
        8510
      ]
    },
    {
      "content": "ABC-123",
      "pos": [
        8513,
        8520
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        8523,
        8551
      ]
    },
    {
      "pos": [
        8555,
        8564
      ],
      "content": "<bpt id=\"p1\">**</bpt>解决方案<ept id=\"p1\">**</ept>："
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>说明<ept id=\"p1\">**</ept>：",
      "pos": [
        8926,
        8933
      ]
    },
    {
      "content": "使用 LAG 来查看后退一个事件之后的输入流，然后即可获得“制造商”字段的值。然后，将其与当前事件的“制造商”字段进行比较，如果二者相同，则输出该事件，并使用 LAG 来获取有关前一辆车的数据。",
      "pos": [
        8934,
        9031
      ]
    },
    {
      "content": "查询示例：检测某个条件的持续时间",
      "pos": [
        9036,
        9052
      ]
    },
    {
      "pos": [
        9056,
        9132
      ],
      "content": "<bpt id=\"p1\">**</bpt>说明<ept id=\"p1\">**</ept>：查看某个条件的持续时间。例如，假设某个 Bug 导致所有车的重量不正确（超出 20,000 磅），于是我们需要计算该 Bug 的持续时间。"
    },
    {
      "pos": [
        9134,
        9141
      ],
      "content": "<bpt id=\"p1\">**</bpt>输入<ept id=\"p1\">**</ept>："
    },
    {
      "content": "请确",
      "pos": [
        9145,
        9147
      ]
    },
    {
      "content": "时间",
      "pos": [
        9150,
        9152
      ]
    },
    {
      "content": "重量",
      "pos": [
        9155,
        9157
      ]
    },
    {
      "content": "Honda",
      "pos": [
        9182,
        9187
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        9190,
        9218
      ]
    },
    {
      "content": "2000",
      "pos": [
        9221,
        9225
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        9230,
        9236
      ]
    },
    {
      "content": "2015-01-01T00:00:02.0000000Z",
      "pos": [
        9239,
        9267
      ]
    },
    {
      "content": "25000",
      "pos": [
        9270,
        9275
      ]
    },
    {
      "content": "Honda",
      "pos": [
        9280,
        9285
      ]
    },
    {
      "content": "2015-01-01T00:00:03.0000000Z",
      "pos": [
        9288,
        9316
      ]
    },
    {
      "content": "26000",
      "pos": [
        9319,
        9324
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        9329,
        9335
      ]
    },
    {
      "content": "2015-01-01T00:00:04.0000000Z",
      "pos": [
        9338,
        9366
      ]
    },
    {
      "content": "25000",
      "pos": [
        9369,
        9374
      ]
    },
    {
      "content": "Honda",
      "pos": [
        9379,
        9384
      ]
    },
    {
      "content": "2015-01-01T00:00:05.0000000Z",
      "pos": [
        9387,
        9415
      ]
    },
    {
      "content": "26000",
      "pos": [
        9418,
        9423
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        9428,
        9434
      ]
    },
    {
      "content": "2015-01-01T00:00:06.0000000Z",
      "pos": [
        9437,
        9465
      ]
    },
    {
      "content": "25000",
      "pos": [
        9468,
        9473
      ]
    },
    {
      "content": "Honda",
      "pos": [
        9478,
        9483
      ]
    },
    {
      "content": "2015-01-01T00:00:07.0000000Z",
      "pos": [
        9486,
        9514
      ]
    },
    {
      "content": "26000",
      "pos": [
        9517,
        9522
      ]
    },
    {
      "content": "Toyota",
      "pos": [
        9527,
        9533
      ]
    },
    {
      "content": "2015-01-01T00:00:08.0000000Z",
      "pos": [
        9536,
        9564
      ]
    },
    {
      "content": "2000",
      "pos": [
        9567,
        9571
      ]
    },
    {
      "pos": [
        9575,
        9582
      ],
      "content": "<bpt id=\"p1\">**</bpt>输出<ept id=\"p1\">**</ept>："
    },
    {
      "content": "StartFault",
      "pos": [
        9586,
        9596
      ]
    },
    {
      "content": "EndFault",
      "pos": [
        9599,
        9607
      ]
    },
    {
      "content": "FaultDurationSeconds",
      "pos": [
        9610,
        9630
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        9655,
        9683
      ]
    },
    {
      "content": "2015-01-01T00:00:08.0000000Z",
      "pos": [
        9686,
        9714
      ]
    },
    {
      "content": "7",
      "pos": [
        9717,
        9718
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        9723,
        9751
      ]
    },
    {
      "content": "2015-01-01T00:00:08.0000000Z",
      "pos": [
        9754,
        9782
      ]
    },
    {
      "content": "7",
      "pos": [
        9785,
        9786
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        9791,
        9819
      ]
    },
    {
      "content": "2015-01-01T00:00:08.0000000Z",
      "pos": [
        9822,
        9850
      ]
    },
    {
      "content": "7",
      "pos": [
        9853,
        9854
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        9859,
        9887
      ]
    },
    {
      "content": "2015-01-01T00:00:08.0000000Z",
      "pos": [
        9890,
        9918
      ]
    },
    {
      "content": "7",
      "pos": [
        9921,
        9922
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        9927,
        9955
      ]
    },
    {
      "content": "2015-01-01T00:00:08.0000000Z",
      "pos": [
        9958,
        9986
      ]
    },
    {
      "content": "7",
      "pos": [
        9989,
        9990
      ]
    },
    {
      "content": "2015-01-01T00:00:01.0000000Z",
      "pos": [
        9995,
        10023
      ]
    },
    {
      "content": "2015-01-01T00:00:08.0000000Z",
      "pos": [
        10026,
        10054
      ]
    },
    {
      "content": "7",
      "pos": [
        10057,
        10058
      ]
    },
    {
      "pos": [
        10062,
        10071
      ],
      "content": "<bpt id=\"p1\">**</bpt>解决方案<ept id=\"p1\">**</ept>："
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>说明<ept id=\"p1\">**</ept>：",
      "pos": [
        10952,
        10959
      ]
    },
    {
      "content": "我们寻找的是 2 个正常事件中夹杂 1 个错误事件且这之中没有正常事件的情况。换句话说，这 2 个事件是位于至少 1 个错误事件之前以及之后的首批事件。获取 2 个在其中夹杂有 1 个错误事件的正常事件很简单，只需使用 2 个 JOIN 操作，然后通过检查重量并比较时间戳来验证我们获得的事件的状态是否为正常 -&gt; 错误 -&gt; 正常即可。",
      "pos": [
        10960,
        11129
      ]
    },
    {
      "content": "在学习“通过 LEFT 外部联接来包括 NULL 或检查事件是否缺失”后，我们知道了如何检查在选取的 2 个正常事件之间是否没有正常事件的发生。",
      "pos": [
        11131,
        11203
      ]
    },
    {
      "content": "将这些组合在一起，我们就可以得到“正常 -&gt; 错误 -&gt; 正常”这样的状态，二者之间没有其他正常事件。现在，我们可以计算开头的正常事件与末尾的正常事件之间的持续时间，从而得出 Bug 的持续时间。",
      "pos": [
        11205,
        11303
      ]
    },
    {
      "content": "获取帮助",
      "pos": [
        11308,
        11312
      ]
    },
    {
      "pos": [
        11313,
        11422
      ],
      "content": "如需进一步的帮助，请尝试我们的 <bpt id=\"p1\">[</bpt>Azure 流分析论坛<ept id=\"p1\">](https://social.msdn.microsoft.com/Forums/zh-CN/home?forum=AzureStreamAnalytics)</ept>"
    },
    {
      "content": "后续步骤",
      "pos": [
        11427,
        11431
      ]
    },
    {
      "content": "Azure 流分析简介",
      "pos": [
        11436,
        11447
      ]
    },
    {
      "content": "Azure 流分析入门",
      "pos": [
        11507,
        11518
      ]
    },
    {
      "content": "缩放 Azure 流分析作业",
      "pos": [
        11577,
        11591
      ]
    },
    {
      "content": "Azure 流分析查询语言参考",
      "pos": [
        11649,
        11664
      ]
    },
    {
      "content": "Azure 流分析管理 REST API 参考",
      "pos": [
        11731,
        11754
      ]
    }
  ],
  "content": "<properties\n    pageTitle=\"流分析中常用使用模式的查询示例 | Azure\"\n    description=\"常见的 Azure 流分析查询模式\"\n    keywords=\"查询示例\"\n    services=\"stream-analytics\"\n    documentationCenter=\"\"\n    authors=\"jeffstokes72\"\n    manager=\"paulettm\"\n    editor=\"cgronlun\"/>\n\n<tags\n    ms.service=\"stream-analytics\"\n    ms.date=\"12/04/2015\"\n    wacn.date=\"01/14/2016\"/>\n\n\n# 常用流分析使用模式的查询示例 #\n\n## 介绍 ##\n\nAzure 流分析中的查询采用类似 SQL 的查询语言来表述，该语言的文档说明见[此处](https://msdn.microsoft.com/zh-cn/library/azure/dn834998.aspx)。本文档概述了针对多个常见查询模式的解决方案，依据的是真实的场景。此工作仍在进行中，将继续使用新的模式不断进行更新。\n\n## 查询示例：数据类型转换 ##\n**说明**：定义输入流中的属性类型，例如，车重在输入流中是字符串格式的，需要转换为 INT 才能执行 SUM 操作。\n\n**输入**：\n\n| 请确 | 时间 | 重量 |\n| --- | --- | --- |\n| Honda | 2015-01-01T00:00:01.0000000Z | \"1000\" |\n| Honda | 2015-01-01T00:00:02.0000000Z | \"2000\" |\n\n**输出**：\n\n| 请确 | 重量 |\n| --- | --- |\n| Honda | 3000 |\n\n**解决方案**：\n\n    SELECT\n        Make,\n        SUM(CAST(Weight AS BIGINT)) AS Weight\n    FROM\n        Input TIMESTAMP BY Time\n    GROUP BY\n        Make,\n        TumblingWindow(second, 10)\n\n**说明**：\n对“重量”字段使用 CAST 语句，以便指定其类型（请在[此处](https://msdn.microsoft.com/zh-cn/library/azure/dn835065.aspx)查看受支持数据类型的列表）。\n\n## 查询示例：使用 Like/Not like 进行模式匹配 ##\n**说明**：查看事件中的某个字段值是否符合特定模式，例如，返回以 A 开头，以 9 结尾的牌照\n\n**输入**：\n\n| 请确 | LicensePlate | 时间 |\n| --- | --- | --- |\n| Honda | ABC-123 | 2015-01-01T00:00:01.0000000Z |\n| Toyota | AAA-999 | 2015-01-01T00:00:02.0000000Z |\n| Nissan | ABC-369 | 2015-01-01T00:00:03.0000000Z |\n\n**输出**：\n\n| 请确 | LicensePlate | 时间 |\n| --- | --- | --- |\n| Toyota | AAA-999 | 2015-01-01T00:00:02.0000000Z |\n| Nissan | ABC-369 | 2015-01-01T00:00:03.0000000Z |\n\n**解决方案**：\n\n    SELECT\n        *\n    FROM\n        Input TIMESTAMP BY Time\n    WHERE\n        LicensePlate LIKE 'A%9'\n\n**说明**：使用 LIKE 语句来查看 LicensePlate 字段值是否以 A 开头、后面所跟的字符串是否包含 0 个或 0 个以上字符，以及是否以 9 结尾。\n\n## 查询示例：指定不同案例/值的逻辑（CASE 语句） ##\n**说明**：根据某些标准为字段提供不同的计算操作。例如，提供一个字符串说明，说明有多少辆制造商相同的车通过，特殊情况下该数目为 1。\n\n**输入**：\n\n| 请确 | 时间 |\n| --- | --- |\n| Honda | 2015-01-01T00:00:01.0000000Z |\n| Toyota | 2015-01-01T00:00:02.0000000Z |\n| Toyota | 2015-01-01T00:00:03.0000000Z |\n\n**输出**：\n\n| CarsPassed | 时间 |\n| --- | --- | --- |\n| 1 辆 Honda | 2015-01-01T00:00:10.0000000Z |\n| 2 辆 Toyota | 2015-01-01T00:00:10.0000000Z |\n\n**解决方案**：\n\n    SELECT\n        CASE\n            WHEN COUNT(*) = 1 THEN CONCAT('1 ', Make)\n            ELSE CONCAT(CAST(COUNT(*) AS NVARCHAR(MAX)), ' ', Make, 's')\n        END AS CarsPassed,\n        System.TimeStamp AS Time\n    FROM\n        Input TIMESTAMP BY Time\n    GROUP BY\n        Make,\n        TumblingWindow(second, 10)\n\n**说明**：\n可以通过 CASE 子句根据某些标准（在我们这个示例中为聚合窗口中车辆的计数）来提供不同的计算操作。\n\n## 查询示例：将数据发送到多个输出 ##\n**说明**：将数据从单个作业发送到多个输出目标。例如，对数据进行分析，根据阈值发出警报，并将所有事件存档到 blob 存储\n\n**输入**：\n\n| 请确 | 时间 |\n| --- | --- |\n| Honda | 2015-01-01T00:00:01.0000000Z |\n| Honda | 2015-01-01T00:00:02.0000000Z |\n| Toyota | 2015-01-01T00:00:01.0000000Z |\n| Toyota | 2015-01-01T00:00:02.0000000Z |\n| Toyota | 2015-01-01T00:00:03.0000000Z |\n\n**输出 1**：\n\n| 请确 | 时间 |\n| --- | --- |\n| Honda | 2015-01-01T00:00:01.0000000Z |\n| Honda | 2015-01-01T00:00:02.0000000Z |\n| Toyota | 2015-01-01T00:00:01.0000000Z |\n| Toyota | 2015-01-01T00:00:02.0000000Z |\n| Toyota | 2015-01-01T00:00:03.0000000Z |\n\n**输出 2**：\n\n| 请确 | 时间 | 计数 |\n| --- | --- | --- |\n| Toyota | 2015-01-01T00:00:10.0000000Z | 3 |\n\n**解决方案**：\n\n    SELECT\n        *\n    INTO\n        ArchiveOutput\n    FROM\n        Input TIMESTAMP BY Time\n\n    SELECT\n        Make,\n        System.TimeStamp AS Time,\n        COUNT(*) AS [Count]\n    INTO\n        AlertOutput\n    FROM\n        Input TIMESTAMP BY Time\n    GROUP BY\n        Make,\n        TumblingWindow(second, 10)\n    HAVING\n        [Count] >= 3\n\n**说明**：\nINTO 子句告诉流分析哪一个输出可以通过此语句写入数据。第一个查询将我们接收到的数据传递到名为 ArchiveOutput 的输出。第二个查询进行了一些简单的聚合和筛选操作，然后将结果发送到下游的报警系统。*注意*：你可以重复使用多个输出语句中的 CTE（即 WITH 语句）结果 – 这有一些额外的好处，例如，在读取输入源时，可以打开较少的读取器。\n\n    WITH AllRedCars AS (\n        SELECT\n            *\n        FROM\n            Input TIMESTAMP BY Time\n        WHERE\n            Color = 'red'\n    )\n    SELECT * INTO HondaOutput FROM AllRedCars WHERE Make = 'Honda'\n    SELECT * INTO ToyotaOutput FROM AllRedCars WHERE Make = 'Toyota'\n\n## 查询示例：对唯一值进行计数\n**说明**：计算某个时段内出现在流中的唯一字段值的数目。例如，在 2 秒内，有多少由某个制造商制造的车通过了收费亭？\n\n**输入**：\n\n| 请确 | 时间 |\n| --- | --- |\n| Honda | 2015-01-01T00:00:01.0000000Z |\n| Honda | 2015-01-01T00:00:02.0000000Z |\n| Toyota | 2015-01-01T00:00:01.0000000Z |\n| Toyota | 2015-01-01T00:00:02.0000000Z |\n| Toyota | 2015-01-01T00:00:03.0000000Z |\n\n**输出：**\n\n| 计数 | 时间 |\n| --- | --- |\n| 2 | 2015-01-01T00:00:02.000Z |\n| 1 | 2015-01-01T00:00:04.000Z |\n\n**解决方案：**\n\n    WITH Makes AS (\n        SELECT\n            Make,\n            COUNT(*) AS CountMake\n        FROM\n            Input TIMESTAMP BY Time\n        GROUP BY\n              Make,\n              TumblingWindow(second, 2)\n    )\n    SELECT\n        COUNT(*) AS Count,\n        System.TimeStamp AS Time\n    FROM\n        Makes\n    GROUP BY\n        TumblingWindow(second, 1)\n\n\n**说明：**\n我们会进行一个初始的聚合来获得该时段内通过的车辆所属的不同制造商以及车辆的计数。然后，我们会进行一个聚合来计算有多少个制造商 – 在提供了某个时段内所有唯一值的情况下，我们可以获得相同的时间戳，然后，第二个聚合窗口需要尽可能小，不能聚合第一步中的 2 个窗口。\n\n## 查询示例：确定某个值是否已更改 ##\n**说明**：查看以前的值，确定其是否不同于当前值。例如，收费公路上前一辆车的制造商是否与目前这辆车的制造商相同？\n\n**输入**：\n\n| 请确 | 时间 |\n| --- | --- |\n| Honda | 2015-01-01T00:00:01.0000000Z |\n| Toyota | 2015-01-01T00:00:02.0000000Z |\n\n**输出**：\n\n| 请确 | 时间 |\n| --- | --- |\n| Toyota | 2015-01-01T00:00:02.0000000Z |\n\n**解决方案**：\n\n    SELECT\n        Make,\n        Time\n    FROM\n        Input TIMESTAMP BY Time\n    WHERE\n        LAG(Make, 1) OVER (LIMIT DURATION(minute, 1)) <> Make\n\n**说明**：\n使用 LAG 来查看后退一个事件之后的输入流，然后即可获得“制造商”字段的值。然后，将其与当前事件的“制造商”字段进行比较，如果二者不同，则输出该事件。\n\n## 查询示例：在窗口中查找第一个事件 ##\n**说明**：查找每个 10 分钟时间间隔内的第一辆车？\n\n**输入**：\n\n| 牌照 | 请确 | 时间 |\n| --- | --- | --- |\n| DXE 5291 | Honda | 2015-07-27T00:00:05.0000000Z |\n| YZK 5704 | Ford | 2015-07-27T00:02:17.0000000Z |\n| RMV 8282 | Honda | 2015-07-27T00:05:01.0000000Z |\n| YHN 6970 | Toyota | 2015-07-27T00:06:00.0000000Z |\n| VFE 1616 | Toyota | 2015-07-27T00:09:31.0000000Z |\n| QYF 9358 | Honda | 2015-07-27T00:12:02.0000000Z |\n| MDR 6128 | BMW | 2015-07-27T00:13:45.0000000Z |\n\n**输出**：\n\n| 牌照 | 请确 | 时间 |\n| --- | --- | --- |\n| DXE 5291 | Honda | 2015-07-27T00:00:05.0000000Z |\n| QYF 9358 | Honda | 2015-07-27T00:12:02.0000000Z |\n\n**解决方案**：\n\n    SELECT \n        LicensePlate,\n        Make,\n        Time\n    FROM \n        Input TIMESTAMP BY Time\n    WHERE \n        IsFirst(minute, 10) = 1\n\n现在，我们来变一下这个问题，查找每 10 分钟时间间隔内特定制造商的第一辆车。\n\n| 牌照 | 请确 | 时间 |\n| --- | --- | --- |\n| DXE 5291 | Honda | 2015-07-27T00:00:05.0000000Z |\n| YZK 5704 | Ford | 2015-07-27T00:02:17.0000000Z |\n| YHN 6970 | Toyota | 2015-07-27T00:06:00.0000000Z |\n| QYF 9358 | Honda | 2015-07-27T00:12:02.0000000Z |\n| MDR 6128 | BMW | 2015-07-27T00:13:45.0000000Z |\n\n**解决方案**：\n\n    SELECT \n        LicensePlate,\n        Make,\n        Time\n    FROM \n        Input TIMESTAMP BY Time\n    WHERE \n        IsFirst(minute, 10) OVER (PARTITION BY Make) = 1\n\n## 查询示例：在窗口中查找最后一个事件 ##\n**说明**：在每 10 分钟时间间隔内查找最后一辆车。\n\n**输入**：\n\n| 牌照 | 请确 | 时间 |\n| --- | --- | --- |\n| DXE 5291 | Honda | 2015-07-27T00:00:05.0000000Z |\n| YZK 5704 | Ford | 2015-07-27T00:02:17.0000000Z |\n| RMV 8282 | Honda | 2015-07-27T00:05:01.0000000Z |\n| YHN 6970 | Toyota | 2015-07-27T00:06:00.0000000Z |\n| VFE 1616 | Toyota | 2015-07-27T00:09:31.0000000Z |\n| QYF 9358 | Honda | 2015-07-27T00:12:02.0000000Z |\n| MDR 6128 | BMW | 2015-07-27T00:13:45.0000000Z |\n\n**输出**：\n\n| 牌照 | 请确 | 时间 |\n| --- | --- | --- |\n| VFE 1616 | Toyota | 2015-07-27T00:09:31.0000000Z |\n| MDR 6128 | BMW | 2015-07-27T00:13:45.0000000Z |\n\n**解决方案**：\n\n    WITH LastInWindow AS\n    (\n        SELECT \n            MAX(Time) AS LastEventTime\n        FROM \n            Input TIMESTAMP BY Time\n        GROUP BY \n            TumblingWindow(minute, 10)\n    )\n    SELECT \n        Input.LicensePlate,\n        Input.Make,\n        Input.Time\n    FROM\n        Input TIMESTAMP BY Time \n        INNER JOIN LastInWindow\n        ON DATEDIFF(minute, Input, LastInWindow) BETWEEN 0 AND 10\n        AND Input.Time = LastInWindow.LastEventTime\n\n**说明**：\n此查询中有两个步骤 – 第一个步骤是查找 10 分钟时间窗口内最后一个时间戳。第二个步骤需要将第一个查询的结果与初始流联接起来，查找每个窗口中与最后一个时间戳匹配的事件。\n\n## 查询示例：检测缺少的事件 ##\n**说明**：查看某个流是否没有值符合特定的标准。例如，在 90 秒内，是否有 2 辆一起进入收费公路的车来自同一制造商？\n\n**输入**：\n\n| 请确 | 牌照 | 时间 |\n| --- | --- | --- |\n| Honda | ABC-123 | 2015-01-01T00:00:01.0000000Z |\n| Honda | AAA-999 | 2015-01-01T00:00:02.0000000Z |\n| Toyota | DEF-987 | 2015-01-01T00:00:03.0000000Z |\n| Honda | GHI-345 | 2015-01-01T00:00:04.0000000Z |\n\n**输出**：\n\n| 请确 | 时间 | CurrentCarLicensePlate | FirstCarLicensePlate | FirstCarTime |\n| --- | --- | --- | --- | --- |\n| Honda | 2015-01-01T00:00:02.0000000Z | AAA-999 | ABC-123 | 2015-01-01T00:00:01.0000000Z |\n\n**解决方案**：\n\n    SELECT\n        Make,\n        Time,\n        LicensePlate AS CurrentCarLicensePlate,\n        LAG(LicensePlate, 1) OVER (LIMIT DURATION(second, 90)) AS FirstCarLicensePlate,\n        LAG(Time, 1) OVER (LIMIT DURATION(second, 90)) AS FirstCarTime\n    FROM\n        Input TIMESTAMP BY Time\n    WHERE\n        LAG(Make, 1) OVER (LIMIT DURATION(second, 90)) = Make\n\n**说明**：\n使用 LAG 来查看后退一个事件之后的输入流，然后即可获得“制造商”字段的值。然后，将其与当前事件的“制造商”字段进行比较，如果二者相同，则输出该事件，并使用 LAG 来获取有关前一辆车的数据。\n\n## 查询示例：检测某个条件的持续时间 ##\n**说明**：查看某个条件的持续时间。例如，假设某个 Bug 导致所有车的重量不正确（超出 20,000 磅），于是我们需要计算该 Bug 的持续时间。\n\n**输入**：\n\n| 请确 | 时间 | 重量 |\n| --- | --- | --- |\n| Honda | 2015-01-01T00:00:01.0000000Z | 2000 |\n| Toyota | 2015-01-01T00:00:02.0000000Z | 25000 |\n| Honda | 2015-01-01T00:00:03.0000000Z | 26000 |\n| Toyota | 2015-01-01T00:00:04.0000000Z | 25000 |\n| Honda | 2015-01-01T00:00:05.0000000Z | 26000 |\n| Toyota | 2015-01-01T00:00:06.0000000Z | 25000 |\n| Honda | 2015-01-01T00:00:07.0000000Z | 26000 |\n| Toyota | 2015-01-01T00:00:08.0000000Z | 2000 |\n\n**输出**：\n\n| StartFault | EndFault | FaultDurationSeconds |\n| --- | --- | --- |\n| 2015-01-01T00:00:01.0000000Z | 2015-01-01T00:00:08.0000000Z | 7 |\n| 2015-01-01T00:00:01.0000000Z | 2015-01-01T00:00:08.0000000Z | 7 |\n| 2015-01-01T00:00:01.0000000Z | 2015-01-01T00:00:08.0000000Z | 7 |\n| 2015-01-01T00:00:01.0000000Z | 2015-01-01T00:00:08.0000000Z | 7 |\n| 2015-01-01T00:00:01.0000000Z | 2015-01-01T00:00:08.0000000Z | 7 |\n| 2015-01-01T00:00:01.0000000Z | 2015-01-01T00:00:08.0000000Z | 7 |\n\n**解决方案**：\n\n    SELECT\n        PrevGood.Time AS StartFault,\n        ThisGood.Time AS Endfault,\n        DATEDIFF(second, PrevGood.Time, ThisGood.Time) AS FaultDuraitonSeconds\n    FROM\n        Input AS ThisGood TIMESTAMP BY Time\n        INNER JOIN Input AS PrevGood TIMESTAMP BY Time\n        ON DATEDIFF(second, PrevGood, ThisGood) BETWEEN 1 AND 3600\n        AND PrevGood.Weight < 20000\n        INNER JOIN Input AS Bad TIMESTAMP BY Time\n        ON DATEDIFF(second, PrevGood, Bad) BETWEEN 1 AND 3600\n        AND DATEDIFF(second, Bad, ThisGood) BETWEEN 1 AND 3600\n        AND Bad.Weight >= 20000\n        LEFT JOIN Input AS MidGood TIMESTAMP BY Time\n        ON DATEDIFF(second, PrevGood, MidGood) BETWEEN 1 AND 3600\n        AND DATEDIFF(second, MidGood, ThisGood) BETWEEN 1 AND 3600\n        AND MidGood.Weight < 20000\n    WHERE\n        ThisGood.Weight < 20000\n        AND MidGood.Weight IS NULL\n\n**说明**：\n我们寻找的是 2 个正常事件中夹杂 1 个错误事件且这之中没有正常事件的情况。换句话说，这 2 个事件是位于至少 1 个错误事件之前以及之后的首批事件。获取 2 个在其中夹杂有 1 个错误事件的正常事件很简单，只需使用 2 个 JOIN 操作，然后通过检查重量并比较时间戳来验证我们获得的事件的状态是否为正常 -> 错误 -> 正常即可。\n\n在学习“通过 LEFT 外部联接来包括 NULL 或检查事件是否缺失”后，我们知道了如何检查在选取的 2 个正常事件之间是否没有正常事件的发生。\n\n将这些组合在一起，我们就可以得到“正常 -> 错误 -> 正常”这样的状态，二者之间没有其他正常事件。现在，我们可以计算开头的正常事件与末尾的正常事件之间的持续时间，从而得出 Bug 的持续时间。\n\n## 获取帮助\n如需进一步的帮助，请尝试我们的 [Azure 流分析论坛](https://social.msdn.microsoft.com/Forums/zh-CN/home?forum=AzureStreamAnalytics)\n\n## 后续步骤\n\n- [Azure 流分析简介](/documentation/articles/stream-analytics-introduction)\n- [Azure 流分析入门](/documentation/articles/stream-analytics-get-started)\n- [缩放 Azure 流分析作业](/documentation/articles/stream-analytics-scale-jobs)\n- [Azure 流分析查询语言参考](https://msdn.microsoft.com/zh-cn/library/azure/dn834998.aspx)\n- [Azure 流分析管理 REST API 参考](https://msdn.microsoft.com/zh-cn/library/azure/dn835031.aspx)\n \n\n<!---HONumber=Mooncake_0104_2016-->"
}