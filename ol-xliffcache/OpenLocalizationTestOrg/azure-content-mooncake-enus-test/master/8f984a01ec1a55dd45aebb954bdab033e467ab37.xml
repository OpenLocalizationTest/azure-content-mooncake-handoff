{
  "nodes": [
    {
      "content": "什么是网络安全组 (NSG)",
      "pos": [
        27,
        41
      ]
    },
    {
      "content": "了解网络安全组 (NSG)",
      "pos": [
        59,
        72
      ]
    },
    {
      "content": "什么是网络安全组 (NSG)？",
      "pos": [
        297,
        312
      ]
    },
    {
      "content": "网络安全组 (NSG) 包含一系列访问控制列表 (ACL) 规则，这些规则可以允许或拒绝虚拟网络中流向 VM 实例的网络流量。NSG 可以与子网或该子网中的各个 VM 实例相关联。当 NSG 与某个子网相关联时，ACL 规则适用于该子网中的所有 VM 实例。另外，可以进一步通过将 NSG 直接关联到单个 VM 对流向该 VM 的流量进行限制。",
      "pos": [
        314,
        486
      ]
    },
    {
      "content": "NSG 资源",
      "pos": [
        491,
        497
      ]
    },
    {
      "content": "NSG 包含以下属性。",
      "pos": [
        499,
        510
      ]
    },
    {
      "content": "属性",
      "pos": [
        513,
        515
      ]
    },
    {
      "content": "说明",
      "pos": [
        516,
        518
      ]
    },
    {
      "content": "约束",
      "pos": [
        519,
        521
      ]
    },
    {
      "content": "注意事项",
      "pos": [
        522,
        526
      ]
    },
    {
      "content": "Name",
      "pos": [
        547,
        551
      ]
    },
    {
      "content": "NSG 的名称",
      "pos": [
        552,
        559
      ]
    },
    {
      "content": "必须在区域内唯一",
      "pos": [
        560,
        568
      ]
    },
    {
      "content": "可以包含字母、数字、下划线、句点和连字符",
      "pos": [
        573,
        593
      ]
    },
    {
      "content": "必须以字母或数字开头",
      "pos": [
        598,
        608
      ]
    },
    {
      "content": "必须以字母、数字或下划线结尾",
      "pos": [
        613,
        627
      ]
    },
    {
      "content": "最多可以有 80 个字符",
      "pos": [
        632,
        644
      ]
    },
    {
      "content": "由于你可能需要创建多个 NSG，因此请确保设置命名约定，以便轻松标识 NSG 的功能。",
      "pos": [
        645,
        688
      ]
    },
    {
      "content": "规则",
      "pos": [
        691,
        693
      ]
    },
    {
      "content": "规则用于定义允许或拒绝的具体流量",
      "pos": [
        694,
        710
      ]
    },
    {
      "pos": [
        712,
        739
      ],
      "content": "请参阅下面的 <bpt id=\"p1\">[</bpt>NSG 规则<ept id=\"p1\">](#Nsg-rules)</ept>"
    },
    {
      "pos": [
        744,
        936
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> 不支持将基于终结点的 ACL 和网络安全组置于相同 VM 实例上。如果你想要使用 NSG，但已有了终结点 ACL，则请先删除该终结点 ACL。有关如何执行此操作的信息，请参阅<bpt id=\"p1\">[</bpt>使用 PowerShell 管理终结点的访问控制列表 (ACL)<ept id=\"p1\">](/documentation/articles/virtual-networks-acl-powershell)</ept>。"
    },
    {
      "pos": [
        941,
        972
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"Nsg-rules\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph> NSG 规则"
    },
    {
      "content": "NSG 规则包含以下属性。",
      "pos": [
        974,
        987
      ]
    },
    {
      "content": "属性",
      "pos": [
        990,
        992
      ]
    },
    {
      "content": "说明",
      "pos": [
        993,
        995
      ]
    },
    {
      "content": "约束",
      "pos": [
        996,
        998
      ]
    },
    {
      "content": "注意事项",
      "pos": [
        999,
        1003
      ]
    },
    {
      "content": "Name",
      "pos": [
        1026,
        1030
      ]
    },
    {
      "content": "规则的名称",
      "pos": [
        1033,
        1038
      ]
    },
    {
      "content": "必须在区域内唯一",
      "pos": [
        1039,
        1047
      ]
    },
    {
      "content": "可以包含字母、数字、下划线、句点和连字符",
      "pos": [
        1052,
        1072
      ]
    },
    {
      "content": "必须以字母或数字开头",
      "pos": [
        1077,
        1087
      ]
    },
    {
      "content": "必须以字母、数字或下划线结尾",
      "pos": [
        1092,
        1106
      ]
    },
    {
      "content": "最多可以有 80 个字符",
      "pos": [
        1111,
        1123
      ]
    },
    {
      "content": "一个 NSG 中可以有多个规则，因此请确保遵循命名约定，以便标识规则的功能",
      "pos": [
        1124,
        1161
      ]
    },
    {
      "content": "协议",
      "pos": [
        1166,
        1168
      ]
    },
    {
      "content": "要与规则匹配的协议",
      "pos": [
        1171,
        1180
      ]
    },
    {
      "content": "TCP、UDP 或 *",
      "pos": [
        1181,
        1192
      ]
    },
    {
      "content": "使用 * 作为协议时，其内容将包括 ICMP（仅限东-西方向的流量）、UDP 和 TCP，这可能会减少所需规则的数目",
      "pos": [
        1193,
        1251
      ]
    },
    {
      "content": "同时，使用 * 对于一种方法来说其范围可能太广泛了，因此请确保只在真正需要时使用",
      "pos": [
        1256,
        1296
      ]
    },
    {
      "content": "Source port range",
      "pos": [
        1301,
        1318
      ]
    },
    {
      "content": "要与规则匹配的源端口范围",
      "pos": [
        1321,
        1333
      ]
    },
    {
      "content": "单个端口号（从 1 到 65535）、端口范围（例如 100-2000）或 *（针对所有端口）",
      "pos": [
        1334,
        1381
      ]
    },
    {
      "content": "尽可能尝试使用端口范围，这样就不需要多个规则",
      "pos": [
        1382,
        1404
      ]
    },
    {
      "content": "Destination port range",
      "pos": [
        1409,
        1431
      ]
    },
    {
      "content": "要与规则匹配的目标端口范围",
      "pos": [
        1434,
        1447
      ]
    },
    {
      "content": "单个端口号（从 1 到 65535）、端口范围（例如 100-2000）或 *（针对所有端口）",
      "pos": [
        1448,
        1495
      ]
    },
    {
      "content": "尽可能尝试使用端口范围，这样就不需要多个规则",
      "pos": [
        1496,
        1518
      ]
    },
    {
      "content": "Source address prefix",
      "pos": [
        1523,
        1544
      ]
    },
    {
      "content": "要与规则匹配的源地址前缀或标记",
      "pos": [
        1547,
        1562
      ]
    },
    {
      "pos": [
        1563,
        1645
      ],
      "content": "单一 IP 地址（例如 10.10.10.10）、IP 子网（例如 192.168.1.0/24）、<bpt id=\"p1\">[</bpt>默认标记<ept id=\"p1\">](#Default-Tags)</ept>或 *（针对所有地址）"
    },
    {
      "content": "考虑使用范围、标记和 * 来减少规则数",
      "pos": [
        1646,
        1665
      ]
    },
    {
      "content": "Destination address prefix",
      "pos": [
        1670,
        1696
      ]
    },
    {
      "content": "要与规则匹配的目标地址前缀或标记",
      "pos": [
        1699,
        1715
      ]
    },
    {
      "pos": [
        1716,
        1798
      ],
      "content": "单一 IP 地址（例如 10.10.10.10）、IP 子网（例如 192.168.1.0/24）、<bpt id=\"p1\">[</bpt>默认标记<ept id=\"p1\">](#Default-Tags)</ept>或 *（针对所有地址）"
    },
    {
      "content": "考虑使用范围、标记和 * 来减少规则数",
      "pos": [
        1799,
        1818
      ]
    },
    {
      "content": "Direction",
      "pos": [
        1823,
        1832
      ]
    },
    {
      "content": "要与规则匹配的流量方向",
      "pos": [
        1835,
        1846
      ]
    },
    {
      "content": "入站或出站",
      "pos": [
        1847,
        1852
      ]
    },
    {
      "content": "入站和出站规则将根据方向分别处理",
      "pos": [
        1853,
        1869
      ]
    },
    {
      "content": "Priority",
      "pos": [
        1874,
        1882
      ]
    },
    {
      "content": "按优先顺序检查规则，只要应用了一个规则，就不会测试其他规则来进行匹配",
      "pos": [
        1885,
        1919
      ]
    },
    {
      "content": "介于 100 到 65535 之间的数字",
      "pos": [
        1920,
        1940
      ]
    },
    {
      "content": "可考虑创建规则跳转优先级（每个规则 100），以便在现有规则之间插入新规则",
      "pos": [
        1941,
        1978
      ]
    },
    {
      "content": "Access",
      "pos": [
        1983,
        1989
      ]
    },
    {
      "content": "规则匹配时要应用的访问类型",
      "pos": [
        1992,
        2005
      ]
    },
    {
      "content": "允许或拒绝",
      "pos": [
        2006,
        2011
      ]
    },
    {
      "content": "请记住，如果找不到某个数据包的允许规则，则丢弃该数据包",
      "pos": [
        2012,
        2039
      ]
    },
    {
      "content": "NSG 包含两种类型的规则：入站规则和出站规则。在每组中，规则的优先级必须保持唯一。",
      "pos": [
        2042,
        2084
      ]
    },
    {
      "content": "NSG 规则处理",
      "pos": [
        2088,
        2096
      ]
    },
    {
      "content": "上图显示如何处理 NSG 规则。",
      "pos": [
        2149,
        2165
      ]
    },
    {
      "pos": [
        2170,
        2202
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"Default-Tags\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph> 默认标记"
    },
    {
      "pos": [
        2204,
        2320
      ],
      "content": "默认标记是系统提供的针对某类 IP 地址的标识符。你可以使用任何规则的 <bpt id=\"p1\">**</bpt>source address prefix<ept id=\"p1\">**</ept> 和 <bpt id=\"p2\">**</bpt>destination address prefix<ept id=\"p2\">**</ept> 属性中的默认标记。有三个可使用的默认标记。"
    },
    {
      "pos": [
        2324,
        2430
      ],
      "content": "<bpt id=\"p1\">**</bpt>VIRTUAL\\_NETWORK:<ept id=\"p1\">**</ept> 此默认标记表示你的所有网络地址空间。它包括虚拟网络地址空间（Azure 中定义的 CIDR 范围）以及所有连接的本地地址空间和连接的 Azure VNet（本地网络）。"
    },
    {
      "pos": [
        2434,
        2523
      ],
      "content": "<bpt id=\"p1\">**</bpt>AZURE\\_LOADBALANCER:<ept id=\"p1\">**</ept> 此默认标记表示 Azure 的基础结构负载平衡器。这将转换到 Azure 数据中心 IP，从中进行 Azure 的运行状况探测。"
    },
    {
      "pos": [
        2527,
        2670
      ],
      "content": "<bpt id=\"p1\">**</bpt>INTERNET:<ept id=\"p1\">**</ept> 此默认标记表示虚拟网络外部的 IP 地址空间，可以通过公共 Internet 进行访问。此范围还包括 <bpt id=\"p2\">[</bpt>Azure 拥有的公共 IP 空间<ept id=\"p2\">](https://www.microsoft.com/download/details.aspx?id=41653)</ept>。"
    },
    {
      "content": "默认规则",
      "pos": [
        2676,
        2680
      ]
    },
    {
      "content": "所有 NSG 都包含一组默认规则。默认规则无法删除，但由于给它们分配的优先级最低，可以用创建的规则来重写它们。",
      "pos": [
        2682,
        2737
      ]
    },
    {
      "content": "正如以下默认规则所阐述的那样，从方向上来说，在 VNet 中发起和结束的流量可以是入站流量，也可以是出站流量。虽然出站方向的流量允许连接到 Internet，但默认情况下，入站方向的流量在连接到 Internet 时会被阻止。有一个默认的规则，该规则允许 Azure 的负载平衡器探测 VM 和角色实例的运行状况。如果不使用负载平衡集，则可以覆盖此规则。",
      "pos": [
        2739,
        2916
      ]
    },
    {
      "content": "入站默认规则",
      "pos": [
        2920,
        2926
      ]
    },
    {
      "content": "Name",
      "pos": [
        2932,
        2936
      ]
    },
    {
      "content": "Priority",
      "pos": [
        2939,
        2947
      ]
    },
    {
      "content": "Source IP",
      "pos": [
        2950,
        2959
      ]
    },
    {
      "content": "Source Port",
      "pos": [
        2962,
        2973
      ]
    },
    {
      "content": "Destination IP",
      "pos": [
        2976,
        2990
      ]
    },
    {
      "content": "Destination Port",
      "pos": [
        2993,
        3009
      ]
    },
    {
      "content": "协议",
      "pos": [
        3012,
        3014
      ]
    },
    {
      "content": "Access",
      "pos": [
        3017,
        3023
      ]
    },
    {
      "content": "ALLOW VNET INBOUND",
      "pos": [
        3169,
        3187
      ]
    },
    {
      "content": "65000",
      "pos": [
        3190,
        3195
      ]
    },
    {
      "content": "VIRTUAL\\_NETWORK",
      "pos": [
        3198,
        3214
      ]
    },
    {
      "content": "*",
      "pos": [
        3217,
        3218
      ]
    },
    {
      "content": "VIRTUAL\\_NETWORK",
      "pos": [
        3221,
        3237
      ]
    },
    {
      "content": "*",
      "pos": [
        3240,
        3241
      ]
    },
    {
      "content": "*",
      "pos": [
        3244,
        3245
      ]
    },
    {
      "content": "ALLOW",
      "pos": [
        3248,
        3253
      ]
    },
    {
      "content": "ALLOW AZURE LOAD BALANCER INBOUND",
      "pos": [
        3258,
        3291
      ]
    },
    {
      "content": "65001",
      "pos": [
        3294,
        3299
      ]
    },
    {
      "content": "AZURE\\_LOADBALANCER",
      "pos": [
        3302,
        3321
      ]
    },
    {
      "content": "*",
      "pos": [
        3324,
        3325
      ]
    },
    {
      "content": "*",
      "pos": [
        3328,
        3329
      ]
    },
    {
      "content": "*",
      "pos": [
        3332,
        3333
      ]
    },
    {
      "content": "*",
      "pos": [
        3336,
        3337
      ]
    },
    {
      "content": "ALLOW",
      "pos": [
        3340,
        3345
      ]
    },
    {
      "content": "DENY ALL INBOUND",
      "pos": [
        3350,
        3366
      ]
    },
    {
      "content": "65500",
      "pos": [
        3369,
        3374
      ]
    },
    {
      "content": "*",
      "pos": [
        3377,
        3378
      ]
    },
    {
      "content": "*",
      "pos": [
        3381,
        3382
      ]
    },
    {
      "content": "*",
      "pos": [
        3385,
        3386
      ]
    },
    {
      "content": "*",
      "pos": [
        3389,
        3390
      ]
    },
    {
      "content": "*",
      "pos": [
        3393,
        3394
      ]
    },
    {
      "content": "DENY",
      "pos": [
        3397,
        3401
      ]
    },
    {
      "content": "出站默认规则",
      "pos": [
        3407,
        3413
      ]
    },
    {
      "content": "Name",
      "pos": [
        3419,
        3423
      ]
    },
    {
      "content": "Priority",
      "pos": [
        3426,
        3434
      ]
    },
    {
      "content": "Source IP",
      "pos": [
        3437,
        3446
      ]
    },
    {
      "content": "Source Port",
      "pos": [
        3449,
        3460
      ]
    },
    {
      "content": "Destination IP",
      "pos": [
        3463,
        3477
      ]
    },
    {
      "content": "Destination Port",
      "pos": [
        3480,
        3496
      ]
    },
    {
      "content": "协议",
      "pos": [
        3499,
        3501
      ]
    },
    {
      "content": "Access",
      "pos": [
        3504,
        3510
      ]
    },
    {
      "content": "ALLOW VNET OUTBOUND",
      "pos": [
        3643,
        3662
      ]
    },
    {
      "content": "65000",
      "pos": [
        3665,
        3670
      ]
    },
    {
      "content": "VIRTUAL\\_NETWORK",
      "pos": [
        3673,
        3689
      ]
    },
    {
      "content": "*",
      "pos": [
        3692,
        3693
      ]
    },
    {
      "content": "VIRTUAL\\_NETWORK",
      "pos": [
        3696,
        3712
      ]
    },
    {
      "content": "*",
      "pos": [
        3715,
        3716
      ]
    },
    {
      "content": "*",
      "pos": [
        3719,
        3720
      ]
    },
    {
      "content": "ALLOW",
      "pos": [
        3723,
        3728
      ]
    },
    {
      "content": "ALLOW INTERNET OUTBOUND",
      "pos": [
        3733,
        3756
      ]
    },
    {
      "content": "65001",
      "pos": [
        3759,
        3764
      ]
    },
    {
      "content": "*",
      "pos": [
        3767,
        3768
      ]
    },
    {
      "content": "*",
      "pos": [
        3771,
        3772
      ]
    },
    {
      "content": "INTERNET",
      "pos": [
        3775,
        3783
      ]
    },
    {
      "content": "*",
      "pos": [
        3786,
        3787
      ]
    },
    {
      "content": "*",
      "pos": [
        3790,
        3791
      ]
    },
    {
      "content": "ALLOW",
      "pos": [
        3794,
        3799
      ]
    },
    {
      "content": "DENY ALL OUTBOUND",
      "pos": [
        3804,
        3821
      ]
    },
    {
      "content": "65500",
      "pos": [
        3824,
        3829
      ]
    },
    {
      "content": "*",
      "pos": [
        3832,
        3833
      ]
    },
    {
      "content": "*",
      "pos": [
        3836,
        3837
      ]
    },
    {
      "content": "*",
      "pos": [
        3840,
        3841
      ]
    },
    {
      "content": "*",
      "pos": [
        3844,
        3845
      ]
    },
    {
      "content": "*",
      "pos": [
        3848,
        3849
      ]
    },
    {
      "content": "DENY",
      "pos": [
        3852,
        3856
      ]
    },
    {
      "content": "将 NSG 相关联",
      "pos": [
        3863,
        3872
      ]
    },
    {
      "content": "可以将 NSG 关联到 VM 和子网，具体取决于你使用的部署模型。",
      "pos": [
        3874,
        3907
      ]
    },
    {
      "pos": [
        4036,
        4108
      ],
      "content": "<bpt id=\"p1\">**</bpt>将 NSG 关联到 VM（仅限经典部署）。<ept id=\"p1\">**</ept> 将 NSG 关联到 VM 时，NSG 中的网络访问规则将应用到传入和传出 VM 的所有流量。"
    },
    {
      "pos": [
        4113,
        4186
      ],
      "content": "<bpt id=\"p1\">**</bpt>将 NSG 关联到子网（所有部署）<ept id=\"p1\">**</ept>。将 NSG 关联到子网时，NSG 中的网络访问规则将应用到子网中的所有 IaaS 和 PaaS 资源。"
    },
    {
      "content": "可以将不同的 NSG 关联到 VM 以及 VM 所绑定到的子网。如果发生这种情况，所有网络访问规则将按以下顺序应用到流量：",
      "pos": [
        4188,
        4249
      ]
    },
    {
      "content": "入站流量",
      "pos": [
        4255,
        4259
      ]
    },
    {
      "content": "应用到子网的 NSG。",
      "pos": [
        4269,
        4280
      ]
    },
    {
      "content": "应用到 VM的 NSG（经典）。",
      "pos": [
        4288,
        4304
      ]
    },
    {
      "content": "出站流量",
      "pos": [
        4309,
        4313
      ]
    },
    {
      "content": "应用到 VM的 NSG（经典）。",
      "pos": [
        4323,
        4339
      ]
    },
    {
      "content": "应用到子网的 NSG。",
      "pos": [
        4347,
        4358
      ]
    },
    {
      "content": "NSG ACL",
      "pos": [
        4362,
        4369
      ]
    },
    {
      "pos": [
        4423,
        4483
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> 尽管你只能将一个 NSG 关联到一个子网、VM，但你可以将同一 NSG 关联到任意数量的资源。"
    },
    {
      "content": "实现",
      "pos": [
        4488,
        4490
      ]
    },
    {
      "content": "你可以使用下列各种工具来实现经典 NSG。",
      "pos": [
        4491,
        4512
      ]
    },
    {
      "content": "|部署工具|经典|",
      "pos": [
        4514,
        4523
      ]
    },
    {
      "content": "|---|---|---|",
      "pos": [
        4524,
        4537
      ]
    },
    {
      "content": "|管理门户|<ph id=\"ph1\">![</ph>否<ph id=\"ph2\">][red]</ph>|",
      "pos": [
        4538,
        4554
      ]
    },
    {
      "content": "|PowerShell|<ph id=\"ph1\">&lt;a href=\"/documentation/articles/virtual-networks-create-nsg-classic-ps\"&gt;</ph><ph id=\"ph2\">![</ph>是<ph id=\"ph3\">][green]&lt;/a&gt;</ph>|",
      "pos": [
        4555,
        4656
      ]
    },
    {
      "content": "|Azure CLI|<ph id=\"ph1\">&lt;a href=\"/documentation/articles/virtual-networks-create-nsg-classic-cli\"&gt;</ph><ph id=\"ph2\">![</ph>是<ph id=\"ph3\">][green]&lt;/a&gt;</ph>|",
      "pos": [
        4657,
        4758
      ]
    },
    {
      "content": "键",
      "pos": [
        4763,
        4764
      ]
    },
    {
      "content": "支持",
      "pos": [
        4767,
        4769
      ]
    },
    {
      "content": "是",
      "pos": [
        4772,
        4773
      ]
    },
    {
      "content": "。单击项目。",
      "pos": [
        4781,
        4787
      ]
    },
    {
      "content": "不支持",
      "pos": [
        4788,
        4791
      ]
    },
    {
      "content": "否",
      "pos": [
        4794,
        4795
      ]
    },
    {
      "content": "。",
      "pos": [
        4801,
        4802
      ]
    },
    {
      "pos": [
        4821,
        4847
      ],
      "content": "<ph id=\"ph1\">&lt;a name=\"Planning\"&gt;</ph><ph id=\"ph2\">&lt;/a&gt;</ph> 规划"
    },
    {
      "content": "在实施 NSG 之前，你需要回答以下问题：",
      "pos": [
        4849,
        4870
      ]
    },
    {
      "content": "你想要筛选哪些类型资源的进出流量，VM、多个 VM 还是他资源（例如连接到同一子网的云服务或应用程序服务环境，或者连接到不同子网的资源）？",
      "pos": [
        4875,
        4944
      ]
    },
    {
      "content": "你要过滤其进出流量的资源是连接到现有 VNet 中的子网，还是连接到新的 VNet 或其子网？",
      "pos": [
        4949,
        4996
      ]
    },
    {
      "pos": [
        4999,
        5103
      ],
      "content": "有关如何针对 Azure 中的网络安全进行规划的详细信息，请参阅<bpt id=\"p1\">[</bpt>云服务和网络安全最佳实践<ept id=\"p1\">](/documentation/articles/best-practices-network-security)</ept>。"
    },
    {
      "content": "设计注意事项",
      "pos": [
        5108,
        5114
      ]
    },
    {
      "pos": [
        5116,
        5163
      ],
      "content": "了解<bpt id=\"p1\">[</bpt>规划<ept id=\"p1\">](#Planning)</ept>部分问题的答案以后，请查看以下内容，然后再定义你的 NSG。"
    },
    {
      "content": "限制",
      "pos": [
        5169,
        5171
      ]
    },
    {
      "content": "在设计 NSG 时需要考虑以下限制。",
      "pos": [
        5173,
        5191
      ]
    },
    {
      "content": "说明",
      "pos": [
        5196,
        5198
      ]
    },
    {
      "content": "默认限制",
      "pos": [
        5203,
        5207
      ]
    },
    {
      "content": "含义",
      "pos": [
        5212,
        5214
      ]
    },
    {
      "content": "可与子网、VM 关联的 NSG 数目",
      "pos": [
        5233,
        5251
      ]
    },
    {
      "content": "1",
      "pos": [
        5252,
        5253
      ]
    },
    {
      "content": "这意味着不能对 NSG 进行组合。确保给定资源集所需的所有规则已包括在单一 NSG 中。",
      "pos": [
        5254,
        5298
      ]
    },
    {
      "content": "每个区域每个订阅的 NSG 数目",
      "pos": [
        5301,
        5317
      ]
    },
    {
      "content": "100",
      "pos": [
        5318,
        5321
      ]
    },
    {
      "content": "默认情况下，你在 Azure 管理门户中创建的每个 VM 都会创建一个新的 NSG。如果你允许此默认行为，则会很快用光 NSG。请确保在设计时牢记此限制，根据需要将资源分成多个区域或订阅。",
      "pos": [
        5322,
        5416
      ]
    },
    {
      "content": "每个 NSG 的 NSG 规则数",
      "pos": [
        5420,
        5436
      ]
    },
    {
      "content": "200",
      "pos": [
        5437,
        5440
      ]
    },
    {
      "content": "使用各种 IP 和端口，确保不超过此限制。",
      "pos": [
        5441,
        5462
      ]
    },
    {
      "pos": [
        5467,
        5618
      ],
      "content": "<ph id=\"ph1\">[AZURE.IMPORTANT]</ph> 在设计解决方案之前，请确保查看所有<bpt id=\"p1\">[</bpt>与 Azure 中的网络服务相关的限制<ept id=\"p1\">](/documentation/articles/azure-subscription-service-limits#networking-limits)</ept>。可以通过开具支持票证增加某些限制。"
    },
    {
      "content": "VNet 和子网设计",
      "pos": [
        5624,
        5634
      ]
    },
    {
      "content": "由于 NSG 可以应用于子网，因此你可以通过按子网来组合资源以及将 NSG 应用到子网来尽量减少 NSG 的数量。如果你决定将 NSG 应用到子网，你可能会发现，现有的 VNet 和子网不是通过所要的 NSG 定义的。你可能需要定义新的 VNet 和子网来支持你的 NSG 设计。同时，你需要将新资源部署到新子网。然后，你才能定义一个迁移策略，将现有资源移到新子网。",
      "pos": [
        5636,
        5819
      ]
    },
    {
      "content": "特殊规则",
      "pos": [
        5825,
        5829
      ]
    },
    {
      "content": "你需要考虑下面所列的特殊规则。请确保不要阻止这些规则允许的流量，否则你的基础结构将无法与基本 Azure 服务通信。",
      "pos": [
        5831,
        5889
      ]
    },
    {
      "pos": [
        5893,
        6139
      ],
      "content": "<bpt id=\"p1\">**</bpt>主机节点的虚拟 IP：<ept id=\"p1\">**</ept>基本基础结构服务（例如 DHCP、DNS 和运行状况监视）是通过虚拟化主机 IP 地址 168.63.129.16 提供的。此公用 IP 地址属于 Microsoft，并将是唯一的用于所有区域的虚拟化 IP 地址，而且没有其他用途。此 IP 地址映射到托管虚拟机的服务器计算机（主机节点）的物理 IP 地址。主机节点充当 DHCP 中继、DNS 递归解析器，以及进行负载平衡器运行状况探测和计算机运行状况探测的探测源。不应将针对此 IP 地址的通信视为一种攻击。"
    },
    {
      "pos": [
        6143,
        6234
      ],
      "content": "<bpt id=\"p1\">**</bpt>许可（密钥管理服务）：<ept id=\"p1\">**</ept>在虚拟机中运行的 Windows 映像应该获得许可。因此，将会向处理此类查询的密钥管理服务主机服务器发送许可请求。这将始终在出站端口 1688 上进行。"
    },
    {
      "content": "ICMP 通信",
      "pos": [
        6240,
        6247
      ]
    },
    {
      "pos": [
        6249,
        6364
      ],
      "content": "当前的 NSG 规则只允许使用 <bpt id=\"p1\">*</bpt>TCP<ept id=\"p1\">*</ept> 或 <bpt id=\"p2\">*</bpt>UDP<ept id=\"p2\">*</ept> 协议。没有 <bpt id=\"p3\">*</bpt>ICMP<ept id=\"p3\">*</ept> 的特定标记。但默认情况下，根据入站 VNet 规则，虚拟网络中允许 ICMP 流量，因为该规则支持 VNet 中任何端口和协议的传入和传出流量。"
    },
    {
      "content": "子网",
      "pos": [
        6370,
        6372
      ]
    },
    {
      "content": "考虑工作负荷所需的层数。可以通过使用子网来隔离每个层，并可将 NSG 应用到该子网。",
      "pos": [
        6376,
        6418
      ]
    },
    {
      "pos": [
        6422,
        6502
      ],
      "content": "如果你需要针对 VPN 网关或 ExpressRoute 线路实现一个子网，请确保<bpt id=\"p1\">**</bpt>不<ept id=\"p1\">**</ept>将 NSG 应用到该子网。否则，跨 VNet 或跨界连接将不起作用。"
    },
    {
      "pos": [
        6505,
        6663
      ],
      "content": "如果你需要实现一个虚拟设备，请确保将该虚拟设备部署在自己的子网上，以便用户定义路由 (UDR) 能够正常工作。你可以实现一个子网级 NSG，以便筛选进出该子网的流量。详细了解<bpt id=\"p1\">[</bpt>如何控制流量和使用虚拟设备<ept id=\"p1\">](/documentation/articles/virtual-networks-udr-overview)</ept>。"
    },
    {
      "content": "其他",
      "pos": [
        6669,
        6671
      ]
    },
    {
      "pos": [
        6675,
        6831
      ],
      "content": "不支持将基于终结点的 ACL 和 NSG 置于相同 VM 实例上。如果你想要使用 NSG，但已有了终结点 ACL，则请先删除该终结点 ACL。有关如何执行此操作的信息，请参阅<bpt id=\"p1\">[</bpt>管理终结点 ACL<ept id=\"p1\">](/documentation/articles/virtual-networks-acl-powershell)</ept>。"
    },
    {
      "content": "与使用负载平衡器类似，在筛选来自其他 VNet 的流量时，你必须使用远程计算机的源地址范围，而不能使用连接 VNet 的网关。",
      "pos": [
        6834,
        6897
      ]
    },
    {
      "content": "许多 Azure 服务不能连接到 Azure 虚拟网络，因此，进出这些服务的流量不能通过 NSG 进行筛选。请阅读所用服务的文档，以确定这些服务能否连接到 VNet。",
      "pos": [
        6900,
        6983
      ]
    },
    {
      "content": "部署示例",
      "pos": [
        6988,
        6992
      ]
    },
    {
      "content": "为了说明如何应用本文中的信息，我们需要定义 NSG，以便筛选一个具有以下要求的两层工作负荷解决方案的网络流量：",
      "pos": [
        6994,
        7049
      ]
    },
    {
      "content": "分隔前端（Windows Web 服务器）和后端（SQL 数据库服务器）的流量。",
      "pos": [
        7054,
        7094
      ]
    },
    {
      "content": "负载平衡规则，将流向负载平衡器的流量转发到端口 80 上的所有 Web 服务器。",
      "pos": [
        7098,
        7138
      ]
    },
    {
      "content": "NAT 规则，将流入负载平衡器端口 50001 的流量转发到前端唯一一个 VM 上的端口 3389。",
      "pos": [
        7142,
        7192
      ]
    },
    {
      "content": "不从 Internet 访问前端或后端 VM，要求 1 例外。",
      "pos": [
        7196,
        7227
      ]
    },
    {
      "content": "不从前端或后端访问 Internet。",
      "pos": [
        7231,
        7250
      ]
    },
    {
      "content": "访问前端端口 3389 的任何 Web 服务器，针对来自前端子网本身的流量。",
      "pos": [
        7254,
        7292
      ]
    },
    {
      "content": "访问后端端口 3389 的所有 SQL Server VM，流量仅来自前端子网。",
      "pos": [
        7296,
        7336
      ]
    },
    {
      "content": "访问后端端口 1433 的所有 SQL Server VM，流量仅来自前端子网。",
      "pos": [
        7340,
        7380
      ]
    },
    {
      "content": "NSG",
      "pos": [
        7384,
        7387
      ]
    },
    {
      "pos": [
        7440,
        7565
      ],
      "content": "如上图所示，<bpt id=\"p1\">*</bpt>Web1<ept id=\"p1\">*</ept> 和 <bpt id=\"p2\">*</bpt>Web2<ept id=\"p2\">*</ept> VM 连接到 <bpt id=\"p3\">*</bpt>FrontEnd<ept id=\"p3\">*</ept> 子网，<bpt id=\"p4\">*</bpt>DB1<ept id=\"p4\">*</ept> 和 <bpt id=\"p5\">*</bpt>DB2<ept id=\"p5\">*</ept> VM 连接到 <bpt id=\"p6\">*</bpt>BackEnd<ept id=\"p6\">*</ept> 子网。两个子网都属于 <bpt id=\"p7\">*</bpt>TestVNet<ept id=\"p7\">*</ept> VNet。所有资源都分配给<bpt id=\"p8\">*</bpt>中国北部<ept id=\"p8\">*</ept> Azure 区域。"
    },
    {
      "content": "上面的要求 1-6（3 除外）全都针对子网空间。为了最大程度地减少每个 NSG 的规则数，同时为了方便将更多 VM 添加到所运行的工作负荷类型与现有 VM 相同的子网，我们可以实施以下子网级 NSG。",
      "pos": [
        7567,
        7667
      ]
    },
    {
      "content": "FrontEnd 子网的 NSG",
      "pos": [
        7673,
        7689
      ]
    },
    {
      "content": "传入规则",
      "pos": [
        7693,
        7697
      ]
    },
    {
      "content": "规则",
      "pos": [
        7702,
        7704
      ]
    },
    {
      "content": "Access",
      "pos": [
        7705,
        7711
      ]
    },
    {
      "content": "Priority",
      "pos": [
        7712,
        7720
      ]
    },
    {
      "content": "Source address range",
      "pos": [
        7721,
        7741
      ]
    },
    {
      "content": "Source port",
      "pos": [
        7742,
        7753
      ]
    },
    {
      "content": "Destination address range",
      "pos": [
        7754,
        7779
      ]
    },
    {
      "content": "Destination port",
      "pos": [
        7780,
        7796
      ]
    },
    {
      "content": "协议",
      "pos": [
        7797,
        7799
      ]
    },
    {
      "content": "允许 HTTP",
      "pos": [
        7836,
        7843
      ]
    },
    {
      "content": "允许",
      "pos": [
        7844,
        7846
      ]
    },
    {
      "content": "100",
      "pos": [
        7847,
        7850
      ]
    },
    {
      "content": "INTERNET",
      "pos": [
        7851,
        7859
      ]
    },
    {
      "content": "*",
      "pos": [
        7860,
        7861
      ]
    },
    {
      "content": "*",
      "pos": [
        7862,
        7863
      ]
    },
    {
      "content": "80",
      "pos": [
        7864,
        7866
      ]
    },
    {
      "content": "TCP",
      "pos": [
        7867,
        7870
      ]
    },
    {
      "content": "允许来自 FrontEnd 的 RDP",
      "pos": [
        7873,
        7892
      ]
    },
    {
      "content": "允许",
      "pos": [
        7893,
        7895
      ]
    },
    {
      "content": "200",
      "pos": [
        7896,
        7899
      ]
    },
    {
      "content": "192\\.168.1.0/24",
      "pos": [
        7900,
        7915
      ]
    },
    {
      "content": "*",
      "pos": [
        7916,
        7917
      ]
    },
    {
      "content": "*",
      "pos": [
        7918,
        7919
      ]
    },
    {
      "content": "3389",
      "pos": [
        7920,
        7924
      ]
    },
    {
      "content": "TCP",
      "pos": [
        7925,
        7928
      ]
    },
    {
      "content": "拒绝来自 Internet 的任何流量",
      "pos": [
        7931,
        7950
      ]
    },
    {
      "content": "拒绝",
      "pos": [
        7951,
        7953
      ]
    },
    {
      "content": "300",
      "pos": [
        7954,
        7957
      ]
    },
    {
      "content": "INTERNET",
      "pos": [
        7958,
        7966
      ]
    },
    {
      "content": "*",
      "pos": [
        7967,
        7968
      ]
    },
    {
      "content": "*",
      "pos": [
        7969,
        7970
      ]
    },
    {
      "content": "*",
      "pos": [
        7971,
        7972
      ]
    },
    {
      "content": "TCP",
      "pos": [
        7973,
        7976
      ]
    },
    {
      "content": "传出规则",
      "pos": [
        7981,
        7985
      ]
    },
    {
      "content": "规则",
      "pos": [
        7990,
        7992
      ]
    },
    {
      "content": "Access",
      "pos": [
        7993,
        7999
      ]
    },
    {
      "content": "Priority",
      "pos": [
        8000,
        8008
      ]
    },
    {
      "content": "Source address range",
      "pos": [
        8009,
        8029
      ]
    },
    {
      "content": "Source port",
      "pos": [
        8030,
        8041
      ]
    },
    {
      "content": "Destination address range",
      "pos": [
        8042,
        8067
      ]
    },
    {
      "content": "Destination port",
      "pos": [
        8068,
        8084
      ]
    },
    {
      "content": "协议",
      "pos": [
        8085,
        8087
      ]
    },
    {
      "content": "拒绝 Internet",
      "pos": [
        8124,
        8135
      ]
    },
    {
      "content": "拒绝",
      "pos": [
        8136,
        8138
      ]
    },
    {
      "content": "100",
      "pos": [
        8139,
        8142
      ]
    },
    {
      "content": "*",
      "pos": [
        8143,
        8144
      ]
    },
    {
      "content": "*",
      "pos": [
        8145,
        8146
      ]
    },
    {
      "content": "INTERNET",
      "pos": [
        8147,
        8155
      ]
    },
    {
      "content": "*",
      "pos": [
        8156,
        8157
      ]
    },
    {
      "content": "*",
      "pos": [
        8158,
        8159
      ]
    },
    {
      "content": "BackEnd 子网的 NSG",
      "pos": [
        8166,
        8181
      ]
    },
    {
      "content": "传入规则",
      "pos": [
        8185,
        8189
      ]
    },
    {
      "content": "规则",
      "pos": [
        8194,
        8196
      ]
    },
    {
      "content": "Access",
      "pos": [
        8197,
        8203
      ]
    },
    {
      "content": "Priority",
      "pos": [
        8204,
        8212
      ]
    },
    {
      "content": "Source address range",
      "pos": [
        8213,
        8233
      ]
    },
    {
      "content": "Source port",
      "pos": [
        8234,
        8245
      ]
    },
    {
      "content": "Destination address range",
      "pos": [
        8246,
        8271
      ]
    },
    {
      "content": "Destination port",
      "pos": [
        8272,
        8288
      ]
    },
    {
      "content": "协议",
      "pos": [
        8289,
        8291
      ]
    },
    {
      "content": "拒绝 Internet",
      "pos": [
        8328,
        8339
      ]
    },
    {
      "content": "拒绝",
      "pos": [
        8340,
        8342
      ]
    },
    {
      "content": "100",
      "pos": [
        8343,
        8346
      ]
    },
    {
      "content": "INTERNET",
      "pos": [
        8347,
        8355
      ]
    },
    {
      "content": "*",
      "pos": [
        8356,
        8357
      ]
    },
    {
      "content": "*",
      "pos": [
        8358,
        8359
      ]
    },
    {
      "content": "*",
      "pos": [
        8360,
        8361
      ]
    },
    {
      "content": "*",
      "pos": [
        8362,
        8363
      ]
    },
    {
      "content": "传出规则",
      "pos": [
        8368,
        8372
      ]
    },
    {
      "content": "规则",
      "pos": [
        8377,
        8379
      ]
    },
    {
      "content": "Access",
      "pos": [
        8380,
        8386
      ]
    },
    {
      "content": "Priority",
      "pos": [
        8387,
        8395
      ]
    },
    {
      "content": "Source address range",
      "pos": [
        8396,
        8416
      ]
    },
    {
      "content": "Source port",
      "pos": [
        8417,
        8428
      ]
    },
    {
      "content": "Destination address range",
      "pos": [
        8429,
        8454
      ]
    },
    {
      "content": "Destination port",
      "pos": [
        8455,
        8471
      ]
    },
    {
      "content": "协议",
      "pos": [
        8472,
        8474
      ]
    },
    {
      "content": "拒绝 Internet",
      "pos": [
        8511,
        8522
      ]
    },
    {
      "content": "拒绝",
      "pos": [
        8523,
        8525
      ]
    },
    {
      "content": "100",
      "pos": [
        8526,
        8529
      ]
    },
    {
      "content": "*",
      "pos": [
        8530,
        8531
      ]
    },
    {
      "content": "*",
      "pos": [
        8532,
        8533
      ]
    },
    {
      "content": "INTERNET",
      "pos": [
        8534,
        8542
      ]
    },
    {
      "content": "*",
      "pos": [
        8543,
        8544
      ]
    },
    {
      "content": "*",
      "pos": [
        8545,
        8546
      ]
    },
    {
      "content": "FrontEnd 中单一 VM 的 NSG，适用于来自 Internet 的 RDP",
      "pos": [
        8553,
        8595
      ]
    },
    {
      "content": "传入规则",
      "pos": [
        8599,
        8603
      ]
    },
    {
      "content": "规则",
      "pos": [
        8608,
        8610
      ]
    },
    {
      "content": "Access",
      "pos": [
        8611,
        8617
      ]
    },
    {
      "content": "Priority",
      "pos": [
        8618,
        8626
      ]
    },
    {
      "content": "Source address range",
      "pos": [
        8627,
        8647
      ]
    },
    {
      "content": "Source port",
      "pos": [
        8648,
        8659
      ]
    },
    {
      "content": "Destination address range",
      "pos": [
        8660,
        8685
      ]
    },
    {
      "content": "Destination port",
      "pos": [
        8686,
        8702
      ]
    },
    {
      "content": "协议",
      "pos": [
        8703,
        8705
      ]
    },
    {
      "content": "允许来自 Internet 的 RDP",
      "pos": [
        8742,
        8761
      ]
    },
    {
      "content": "允许",
      "pos": [
        8762,
        8764
      ]
    },
    {
      "content": "100",
      "pos": [
        8765,
        8768
      ]
    },
    {
      "content": "INTERNET",
      "pos": [
        8769,
        8777
      ]
    },
    {
      "content": "**",
      "pos": [
        8778,
        8780
      ]
    },
    {
      "content": "*",
      "pos": [
        8781,
        8782
      ]
    },
    {
      "content": "3389",
      "pos": [
        8783,
        8787
      ]
    },
    {
      "content": "TCP",
      "pos": [
        8788,
        8791
      ]
    },
    {
      "pos": [
        8795,
        8939
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> 请注意，此规则的源地址范围是 <bpt id=\"p1\">**</bpt>Internet<ept id=\"p1\">**</ept>，不是负载平衡器的 VIP；源端口是 <bpt id=\"p2\">**</bpt>\\*<ept id=\"p2\">**</ept>，不是 500001。请勿混淆 NAT 规则/负载平衡规则和 NSG 规则。NSG 规则始终与流量的最初源和最终目标相关，与二者之间的负载平衡器<bpt id=\"p3\">**</bpt>无关<ept id=\"p3\">**</ept>。"
    },
    {
      "content": "后续步骤",
      "pos": [
        8944,
        8948
      ]
    },
    {
      "pos": [
        8952,
        9033
      ],
      "content": "<bpt id=\"p1\">[</bpt>在经典部署模型中部署 NSG<ept id=\"p1\">](/documentation/articles/virtual-networks-create-nsg-classic-ps)</ept>。"
    },
    {
      "pos": [
        9036,
        9104
      ],
      "content": "<bpt id=\"p1\">[</bpt>管理 NSG 日志<ept id=\"p1\">](/documentation/articles/virtual-network-nsg-manage-log)</ept>。"
    }
  ],
  "content": "<properties \n   pageTitle=\"什么是网络安全组 (NSG)\"\n   description=\"了解网络安全组 (NSG)\"\n   services=\"virtual-network\"\n   documentationCenter=\"na\"\n   authors=\"telmosampaio\"\n   manager=\"carmonm\"\n   editor=\"tysonn\" />\n<tags\n    ms.service=\"virtual-network\"\n    ms.date=\"02/11/2016\"\n    wacn.date=\"03/17/2016\"/>\n\n# 什么是网络安全组 (NSG)？\n\n网络安全组 (NSG) 包含一系列访问控制列表 (ACL) 规则，这些规则可以允许或拒绝虚拟网络中流向 VM 实例的网络流量。NSG 可以与子网或该子网中的各个 VM 实例相关联。当 NSG 与某个子网相关联时，ACL 规则适用于该子网中的所有 VM 实例。另外，可以进一步通过将 NSG 直接关联到单个 VM 对流向该 VM 的流量进行限制。\n\n## NSG 资源\n\nNSG 包含以下属性。\n\n|属性|说明|约束|注意事项|\n|---|---|---|---|\n|Name|NSG 的名称|必须在区域内唯一<br/>可以包含字母、数字、下划线、句点和连字符<br/>必须以字母或数字开头<br/>必须以字母、数字或下划线结尾<br/>最多可以有 80 个字符|由于你可能需要创建多个 NSG，因此请确保设置命名约定，以便轻松标识 NSG 的功能。|\n|规则|规则用于定义允许或拒绝的具体流量||请参阅下面的 [NSG 规则](#Nsg-rules)| \n\n>[AZURE.NOTE] 不支持将基于终结点的 ACL 和网络安全组置于相同 VM 实例上。如果你想要使用 NSG，但已有了终结点 ACL，则请先删除该终结点 ACL。有关如何执行此操作的信息，请参阅[使用 PowerShell 管理终结点的访问控制列表 (ACL)](/documentation/articles/virtual-networks-acl-powershell)。\n\n###<a name=\"Nsg-rules\"></a> NSG 规则\n\nNSG 规则包含以下属性。\n\n|属性|说明|约束|注意事项|\n|---|---|---|---|\n|**Name**|规则的名称|必须在区域内唯一<br/>可以包含字母、数字、下划线、句点和连字符<br/>必须以字母或数字开头<br/>必须以字母、数字或下划线结尾<br/>最多可以有 80 个字符|一个 NSG 中可以有多个规则，因此请确保遵循命名约定，以便标识规则的功能|\n|**协议**|要与规则匹配的协议|TCP、UDP 或 *|使用 * 作为协议时，其内容将包括 ICMP（仅限东-西方向的流量）、UDP 和 TCP，这可能会减少所需规则的数目<br/>同时，使用 * 对于一种方法来说其范围可能太广泛了，因此请确保只在真正需要时使用|\n|**Source port range**|要与规则匹配的源端口范围|单个端口号（从 1 到 65535）、端口范围（例如 100-2000）或 *（针对所有端口）|尽可能尝试使用端口范围，这样就不需要多个规则|\n|**Destination port range**|要与规则匹配的目标端口范围|单个端口号（从 1 到 65535）、端口范围（例如 100-2000）或 *（针对所有端口）|尽可能尝试使用端口范围，这样就不需要多个规则|\n|**Source address prefix**|要与规则匹配的源地址前缀或标记|单一 IP 地址（例如 10.10.10.10）、IP 子网（例如 192.168.1.0/24）、[默认标记](#Default-Tags)或 *（针对所有地址）|考虑使用范围、标记和 * 来减少规则数|\n|**Destination address prefix**|要与规则匹配的目标地址前缀或标记|单一 IP 地址（例如 10.10.10.10）、IP 子网（例如 192.168.1.0/24）、[默认标记](#Default-Tags)或 *（针对所有地址）|考虑使用范围、标记和 * 来减少规则数|\n|**Direction**|要与规则匹配的流量方向|入站或出站|入站和出站规则将根据方向分别处理|\n|**Priority**|按优先顺序检查规则，只要应用了一个规则，就不会测试其他规则来进行匹配|介于 100 到 65535 之间的数字|可考虑创建规则跳转优先级（每个规则 100），以便在现有规则之间插入新规则|\n|**Access**|规则匹配时要应用的访问类型|允许或拒绝|请记住，如果找不到某个数据包的允许规则，则丢弃该数据包|\n\nNSG 包含两种类型的规则：入站规则和出站规则。在每组中，规则的优先级必须保持唯一。\n\n![NSG 规则处理](./media/virtual-network-nsg-overview/figure3.png)\n\n上图显示如何处理 NSG 规则。\n\n###<a name=\"Default-Tags\"></a> 默认标记\n\n默认标记是系统提供的针对某类 IP 地址的标识符。你可以使用任何规则的 **source address prefix** 和 **destination address prefix** 属性中的默认标记。有三个可使用的默认标记。\n\n- **VIRTUAL\\_NETWORK:** 此默认标记表示你的所有网络地址空间。它包括虚拟网络地址空间（Azure 中定义的 CIDR 范围）以及所有连接的本地地址空间和连接的 Azure VNet（本地网络）。\n\n- **AZURE\\_LOADBALANCER:** 此默认标记表示 Azure 的基础结构负载平衡器。这将转换到 Azure 数据中心 IP，从中进行 Azure 的运行状况探测。\n\n- **INTERNET:** 此默认标记表示虚拟网络外部的 IP 地址空间，可以通过公共 Internet 进行访问。此范围还包括 [Azure 拥有的公共 IP 空间](https://www.microsoft.com/download/details.aspx?id=41653)。\n\n### 默认规则\n\n所有 NSG 都包含一组默认规则。默认规则无法删除，但由于给它们分配的优先级最低，可以用创建的规则来重写它们。\n\n正如以下默认规则所阐述的那样，从方向上来说，在 VNet 中发起和结束的流量可以是入站流量，也可以是出站流量。虽然出站方向的流量允许连接到 Internet，但默认情况下，入站方向的流量在连接到 Internet 时会被阻止。有一个默认的规则，该规则允许 Azure 的负载平衡器探测 VM 和角色实例的运行状况。如果不使用负载平衡集，则可以覆盖此规则。\n\n**入站默认规则**\n\n| Name | Priority | Source IP | Source Port | Destination IP | Destination Port | 协议 | Access |\n|-----------------------------------|----------|--------------------|-------------|-----------------|------------------|----------|--------|\n| ALLOW VNET INBOUND | 65000 | VIRTUAL\\_NETWORK | * | VIRTUAL\\_NETWORK | * | * | ALLOW |\n| ALLOW AZURE LOAD BALANCER INBOUND | 65001 | AZURE\\_LOADBALANCER | * | * | * | * | ALLOW |\n| DENY ALL INBOUND | 65500 | * | * | * | * | * | DENY |\n\n**出站默认规则**\n\n| Name | Priority | Source IP | Source Port | Destination IP | Destination Port | 协议 | Access |\n|-------------------------|----------|-----------------|-------------|-----------------|------------------|----------|--------|\n| ALLOW VNET OUTBOUND | 65000 | VIRTUAL\\_NETWORK | * | VIRTUAL\\_NETWORK | * | * | ALLOW |\n| ALLOW INTERNET OUTBOUND | 65001 | * | * | INTERNET | * | * | ALLOW |\n| DENY ALL OUTBOUND | 65500 | * | * | * | * | * | DENY |\n\n## 将 NSG 相关联\n\n可以将 NSG 关联到 VM 和子网，具体取决于你使用的部署模型。\n\n[AZURE.INCLUDE [learn-about-deployment-models-both-include.md](../includes/learn-about-deployment-models-both-include.md)]\n \n- **将 NSG 关联到 VM（仅限经典部署）。** 将 NSG 关联到 VM 时，NSG 中的网络访问规则将应用到传入和传出 VM 的所有流量。 \n\n- **将 NSG 关联到子网（所有部署）**。将 NSG 关联到子网时，NSG 中的网络访问规则将应用到子网中的所有 IaaS 和 PaaS 资源。\n\n可以将不同的 NSG 关联到 VM 以及 VM 所绑定到的子网。如果发生这种情况，所有网络访问规则将按以下顺序应用到流量：\n\n- **入站流量**\n    1. 应用到子网的 NSG。\n    2. 应用到 VM的 NSG（经典）。\n- **出站流量**\n    1. 应用到 VM的 NSG（经典）。\n    2. 应用到子网的 NSG。\n\n![NSG ACL](./media/virtual-network-nsg-overview/figure2.png)\n\n>[AZURE.NOTE] 尽管你只能将一个 NSG 关联到一个子网、VM，但你可以将同一 NSG 关联到任意数量的资源。\n\n## 实现\n你可以使用下列各种工具来实现经典 NSG。\n\n|部署工具|经典|\n|---|---|---|\n|管理门户|![否][red]|\n|PowerShell|<a href=\"/documentation/articles/virtual-networks-create-nsg-classic-ps\">![是][green]</a>|\n|Azure CLI|<a href=\"/documentation/articles/virtual-networks-create-nsg-classic-cli\">![是][green]</a>|\n\n|**键**|支持 ![是][green]。单击项目。|不支持 ![否][red]。|\n|---|---|---|\n\n##<a name=\"Planning\"></a> 规划\n\n在实施 NSG 之前，你需要回答以下问题：\n\n1. 你想要筛选哪些类型资源的进出流量，VM、多个 VM 还是他资源（例如连接到同一子网的云服务或应用程序服务环境，或者连接到不同子网的资源）？\n\n2. 你要过滤其进出流量的资源是连接到现有 VNet 中的子网，还是连接到新的 VNet 或其子网？\n \n有关如何针对 Azure 中的网络安全进行规划的详细信息，请参阅[云服务和网络安全最佳实践](/documentation/articles/best-practices-network-security)。\n\n## 设计注意事项\n\n了解[规划](#Planning)部分问题的答案以后，请查看以下内容，然后再定义你的 NSG。\n\n### 限制\n\n在设计 NSG 时需要考虑以下限制。\n\n|**说明**|**默认限制**|**含义**|\n|---|---|---|\n|可与子网、VM 关联的 NSG 数目|1|这意味着不能对 NSG 进行组合。确保给定资源集所需的所有规则已包括在单一 NSG 中。|\n|每个区域每个订阅的 NSG 数目|100|默认情况下，你在 Azure 管理门户中创建的每个 VM 都会创建一个新的 NSG。如果你允许此默认行为，则会很快用光 NSG。请确保在设计时牢记此限制，根据需要将资源分成多个区域或订阅。 |\n|每个 NSG 的 NSG 规则数|200|使用各种 IP 和端口，确保不超过此限制。 |\n\n>[AZURE.IMPORTANT] 在设计解决方案之前，请确保查看所有[与 Azure 中的网络服务相关的限制](/documentation/articles/azure-subscription-service-limits#networking-limits)。可以通过开具支持票证增加某些限制。\n\n### VNet 和子网设计\n\n由于 NSG 可以应用于子网，因此你可以通过按子网来组合资源以及将 NSG 应用到子网来尽量减少 NSG 的数量。如果你决定将 NSG 应用到子网，你可能会发现，现有的 VNet 和子网不是通过所要的 NSG 定义的。你可能需要定义新的 VNet 和子网来支持你的 NSG 设计。同时，你需要将新资源部署到新子网。然后，你才能定义一个迁移策略，将现有资源移到新子网。\n\n### 特殊规则\n\n你需要考虑下面所列的特殊规则。请确保不要阻止这些规则允许的流量，否则你的基础结构将无法与基本 Azure 服务通信。\n\n- **主机节点的虚拟 IP：**基本基础结构服务（例如 DHCP、DNS 和运行状况监视）是通过虚拟化主机 IP 地址 168.63.129.16 提供的。此公用 IP 地址属于 Microsoft，并将是唯一的用于所有区域的虚拟化 IP 地址，而且没有其他用途。此 IP 地址映射到托管虚拟机的服务器计算机（主机节点）的物理 IP 地址。主机节点充当 DHCP 中继、DNS 递归解析器，以及进行负载平衡器运行状况探测和计算机运行状况探测的探测源。不应将针对此 IP 地址的通信视为一种攻击。\n\n- **许可（密钥管理服务）：**在虚拟机中运行的 Windows 映像应该获得许可。因此，将会向处理此类查询的密钥管理服务主机服务器发送许可请求。这将始终在出站端口 1688 上进行。\n\n### ICMP 通信\n\n当前的 NSG 规则只允许使用 *TCP* 或 *UDP* 协议。没有 *ICMP* 的特定标记。但默认情况下，根据入站 VNet 规则，虚拟网络中允许 ICMP 流量，因为该规则支持 VNet 中任何端口和协议的传入和传出流量。\n\n### 子网\n\n- 考虑工作负荷所需的层数。可以通过使用子网来隔离每个层，并可将 NSG 应用到该子网。 \n- 如果你需要针对 VPN 网关或 ExpressRoute 线路实现一个子网，请确保**不**将 NSG 应用到该子网。否则，跨 VNet 或跨界连接将不起作用。\n- 如果你需要实现一个虚拟设备，请确保将该虚拟设备部署在自己的子网上，以便用户定义路由 (UDR) 能够正常工作。你可以实现一个子网级 NSG，以便筛选进出该子网的流量。详细了解[如何控制流量和使用虚拟设备](/documentation/articles/virtual-networks-udr-overview)。\n\n### 其他\n\n- 不支持将基于终结点的 ACL 和 NSG 置于相同 VM 实例上。如果你想要使用 NSG，但已有了终结点 ACL，则请先删除该终结点 ACL。有关如何执行此操作的信息，请参阅[管理终结点 ACL](/documentation/articles/virtual-networks-acl-powershell)。\n- 与使用负载平衡器类似，在筛选来自其他 VNet 的流量时，你必须使用远程计算机的源地址范围，而不能使用连接 VNet 的网关。\n- 许多 Azure 服务不能连接到 Azure 虚拟网络，因此，进出这些服务的流量不能通过 NSG 进行筛选。请阅读所用服务的文档，以确定这些服务能否连接到 VNet。\n\n## 部署示例\n\n为了说明如何应用本文中的信息，我们需要定义 NSG，以便筛选一个具有以下要求的两层工作负荷解决方案的网络流量：\n\n1. 分隔前端（Windows Web 服务器）和后端（SQL 数据库服务器）的流量。\n2. 负载平衡规则，将流向负载平衡器的流量转发到端口 80 上的所有 Web 服务器。\n3. NAT 规则，将流入负载平衡器端口 50001 的流量转发到前端唯一一个 VM 上的端口 3389。\n4. 不从 Internet 访问前端或后端 VM，要求 1 例外。\n5. 不从前端或后端访问 Internet。\n6. 访问前端端口 3389 的任何 Web 服务器，针对来自前端子网本身的流量。\n7. 访问后端端口 3389 的所有 SQL Server VM，流量仅来自前端子网。\n8. 访问后端端口 1433 的所有 SQL Server VM，流量仅来自前端子网。\n\n![NSG](./media/virtual-network-nsg-overview/figure1.png)\n\n如上图所示，*Web1* 和 *Web2* VM 连接到 *FrontEnd* 子网，*DB1* 和 *DB2* VM 连接到 *BackEnd* 子网。两个子网都属于 *TestVNet* VNet。所有资源都分配给*中国北部* Azure 区域。\n\n上面的要求 1-6（3 除外）全都针对子网空间。为了最大程度地减少每个 NSG 的规则数，同时为了方便将更多 VM 添加到所运行的工作负荷类型与现有 VM 相同的子网，我们可以实施以下子网级 NSG。\n\n### FrontEnd 子网的 NSG\n\n**传入规则**\n\n|规则|Access|Priority|Source address range|Source port|Destination address range|Destination port|协议|\n|---|---|---|---|---|---|---|---|\n|允许 HTTP|允许|100|INTERNET|*|*|80|TCP|\n|允许来自 FrontEnd 的 RDP|允许|200|192\\.168.1.0/24|*|*|3389|TCP|\n|拒绝来自 Internet 的任何流量|拒绝|300|INTERNET|*|*|*|TCP|\n\n**传出规则**\n\n|规则|Access|Priority|Source address range|Source port|Destination address range|Destination port|协议|\n|---|---|---|---|---|---|---|---|\n|拒绝 Internet|拒绝|100|*|*|INTERNET|*|*|\n\n### BackEnd 子网的 NSG\n\n**传入规则**\n\n|规则|Access|Priority|Source address range|Source port|Destination address range|Destination port|协议|\n|---|---|---|---|---|---|---|---|\n|拒绝 Internet|拒绝|100|INTERNET|*|*|*|*|\n\n**传出规则**\n\n|规则|Access|Priority|Source address range|Source port|Destination address range|Destination port|协议|\n|---|---|---|---|---|---|---|---|\n|拒绝 Internet|拒绝|100|*|*|INTERNET|*|*|\n\n### FrontEnd 中单一 VM 的 NSG，适用于来自 Internet 的 RDP\n\n**传入规则**\n\n|规则|Access|Priority|Source address range|Source port|Destination address range|Destination port|协议|\n|---|---|---|---|---|---|---|---|\n|允许来自 Internet 的 RDP|允许|100|INTERNET|**|*|3389|TCP|\n\n>[AZURE.NOTE] 请注意，此规则的源地址范围是 **Internet**，不是负载平衡器的 VIP；源端口是 **\\***，不是 500001。请勿混淆 NAT 规则/负载平衡规则和 NSG 规则。NSG 规则始终与流量的最初源和最终目标相关，与二者之间的负载平衡器**无关**。\n\n## 后续步骤\n\n- [在经典部署模型中部署 NSG](/documentation/articles/virtual-networks-create-nsg-classic-ps)。\n- [管理 NSG 日志](/documentation/articles/virtual-network-nsg-manage-log)。\n\n[green]: ./media/virtual-network-nsg-overview/green.png\n[yellow]: ./media/virtual-network-nsg-overview/yellow.png\n[red]: ./media/virtual-network-nsg-overview/red.png\n\n<!---HONumber=Mooncake_0307_2016-->"
}